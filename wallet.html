<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=99">
</head>

<body class="adminShell">
  <aside class="sideNav">
    <div class="sideTop">
      <div class="sideLogo">BM</div>
      <div>
        <div class="sideName">Buckup-Media</div>
        <div class="sideSub">Wallet</div>
      </div>
    </div>

    <nav class="sideMenu">
      <button class="navItem" id="goHome">Home</button>
      <button class="navItem" id="goAccounts">Accounts</button>
      <button class="navItem" id="goTool">Data Duplicater</button>
      <button class="navItem active">Wallet</button>
      <button class="navItem" id="goAdmin">Admin</button>
    </nav>

    <div class="sideBottom">
      <div class="sideHint">Secure ledger</div>
      <div class="sideSmall">© Buckup-Media</div>
    </div>
  </aside>

  <div class="mainArea">
    <header class="topBar">
      <div>
        <div class="topTitle">Wallet</div>
        <div class="topSub">Statement • Downloads • Filters</div>
      </div>

      <div class="topRight">
        <!-- Theme switch -->
        <div class="themeSwitch">
          <span class="themeLabel">Theme</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>

        <span class="chip" id="verChip">Verified</span>
        <button class="toolBtn ghost" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <main class="content">
      <section class="page show">

        <div class="walletGrid">
          <div class="walletHeroCard hoverParallax" data-tilt>
            <div class="wHead">
              <div>
                <div class="wLabel">Available Balance</div>

                <!-- Animated gradient balance -->
                <div class="wBal wBalGlow" id="bal">₹ —</div>

                <div class="wMetaLine" id="rateLine">Rate: ₹ — / account</div>
              </div>
              <div class="wBadge">₹</div>
            </div>

            <div class="wMiniStats">
              <div class="wStat">
                <div class="wStatLabel">Credits</div>
                <div class="wStatVal" id="credits">₹ —</div>
              </div>
              <div class="wStat">
                <div class="wStatLabel">Deductions</div>
                <div class="wStatVal" id="debits">₹ —</div>
              </div>
              <div class="wStat">
                <div class="wStatLabel">Net</div>
                <div class="wStatVal" id="net">₹ —</div>
              </div>
            </div>

            <div class="wNotice">
              <b>Rule:</b> deduction is <b>ONCE per account</b> if tagged locked / incorrect password. (30-minute slot system handled server-side).
            </div>
          </div>

          <div class="walletHeroCard soft hoverParallax" data-tilt>
            <div class="wHead">
              <div>
                <div class="wLabel">Statement Filters</div>
                <div class="wMetaLine">Pick range then export</div>
              </div>
              <div class="wBadge alt">S</div>
            </div>

            <div class="wControls">
              <div class="pillGroup" id="rangePills">
                <button class="pill active" data-range="3m">Last 3 months</button>
                <button class="pill" data-range="6m">Last 6 months</button>
                <button class="pill" data-range="all">All</button>
              </div>

              <div class="datePack">
                <input id="fromDate" type="date" class="toolInput compact">
                <span class="dateSep">→</span>
                <input id="toDate" type="date" class="toolInput compact">
              </div>

              <div class="wBtns">
                <button class="toolBtn primary" id="downloadCSV">Download CSV</button>
                <button class="toolBtn ghost" id="downloadTXT">Download TXT</button>
              </div>

              <div class="toolHint">
                Using manual dates overrides pills.
              </div>
            </div>
          </div>
        </div>

        <div class="cardX hoverParallax" data-tilt style="margin-top:16px;">
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Statement</div>
              <div class="cardXSub">Credits / Debits ledger</div>
            </div>

            <div class="searchMiniWrap">
              <input id="miniSearch" class="toolInput compact" placeholder="Search (reason / amount / count)">
            </div>
          </div>

          <div id="er" class="toolMsg err"></div>

          <div class="accTableWrap" style="margin-top:12px;">
            <table class="accTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Accounts</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="rows">
                <!-- Skeleton loading -->
                <tr class="skRow"><td colspan="5">
                  <div class="skLine"></div>
                  <div class="skLine w80"></div>
                  <div class="skLine w60"></div>
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </section>
    </main>
  </div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getSession } from "./cache.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    doc, getDoc, collection, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Require login
  const sess = getSession();
  if (!sess) location.href = "index.html";

  onAuthStateChanged(auth, (user) => {
    if (!user) location.href = "index.html";
    if (!user.emailVerified) location.href = "index.html";
  });

  // NAV
  document.getElementById("goHome").onclick = ()=> location.href = "home.html";
  document.getElementById("goAccounts").onclick = ()=> location.href = "accounts.html";
  document.getElementById("goTool").onclick = ()=> location.href = "dashboard.html";
  document.getElementById("goAdmin").onclick = ()=> location.href = "admin.html";
  document.getElementById("refreshBtn").onclick = ()=> location.reload();

  // Coin sound (no file)
  function playCoin(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const now = ctx.currentTime;

      const o1 = ctx.createOscillator(), g1 = ctx.createGain();
      o1.type = "triangle";
      o1.frequency.setValueAtTime(880, now);
      o1.frequency.exponentialRampToValueAtTime(1320, now + 0.06);
      g1.gain.setValueAtTime(0.0001, now);
      g1.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
      g1.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
      o1.connect(g1); g1.connect(ctx.destination);

      const o2 = ctx.createOscillator(), g2 = ctx.createGain();
      o2.type = "sine";
      o2.frequency.setValueAtTime(660, now);
      o2.frequency.exponentialRampToValueAtTime(990, now + 0.05);
      g2.gain.setValueAtTime(0.0001, now);
      g2.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
      g2.gain.exponentialRampToValueAtTime(0.0001, now + 0.10);
      o2.connect(g2); g2.connect(ctx.destination);

      o1.start(now); o2.start(now);
      o1.stop(now + 0.13); o2.stop(now + 0.11);
      setTimeout(()=>ctx.close().catch(()=>{}), 220);
    }catch{}
  }

  // Play coin sound only if coming from Home/Wallet click
  if (sessionStorage.getItem("bm_wallet_sound") === "1") {
    sessionStorage.removeItem("bm_wallet_sound");
    setTimeout(playCoin, 120);
  }

  // THEME TOGGLE
  const themeToggle = document.getElementById("themeToggle");
  (function initTheme(){
    const saved = localStorage.getItem("bm_theme") || "dark";
    document.documentElement.setAttribute("data-theme", saved);
    themeToggle.checked = saved === "light";
    themeToggle.addEventListener("change", () => {
      const mode = themeToggle.checked ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", mode);
      localStorage.setItem("bm_theme", mode);
    });
  })();

  // UI refs
  const er = document.getElementById("er");
  const rows = document.getElementById("rows");
  const miniSearch = document.getElementById("miniSearch");

  const balEl = document.getElementById("bal");
  const rateLine = document.getElementById("rateLine");
  const creditsEl = document.getElementById("credits");
  const debitsEl = document.getElementById("debits");
  const netEl = document.getElementById("net");

  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");

  let allRuns = [];

  // Helpers
  function fmtMoney(n){
    const x = Number(n || 0);
    return "₹ " + x.toLocaleString("en-IN");
  }
  function fmtTime(ts){
    try{
      if (!ts) return "—";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }catch{ return "—"; }
  }
  function showErr(t){
    er.style.display = "block";
    er.textContent = t;
  }
  function clearErr(){
    er.style.display = "none";
    er.textContent = "";
  }

  function setSkeleton(){
    rows.innerHTML = `
      <tr class="skRow"><td colspan="5">
        <div class="skLine"></div>
        <div class="skLine w80"></div>
        <div class="skLine w60"></div>
      </td></tr>
    `;
  }

  function withinRange(ts){
    if (!ts) return false;
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const f = fromDate.value ? new Date(fromDate.value + "T00:00:00") : null;
    const t = toDate.value ? new Date(toDate.value + "T23:59:59") : null;
    if (f && d < f) return false;
    if (t && d > t) return false;
    return true;
  }

  function matchesSearch(run){
    const q = (miniSearch.value || "").trim().toLowerCase();
    if (!q) return true;
    const reason = (run.reason || "").toLowerCase();
    const desc = (run.description || "").toLowerCase();
    const amt = String(run.amount || "").toLowerCase();
    const cnt = String(run.accountsCount || "").toLowerCase();
    return reason.includes(q) || desc.includes(q) || amt.includes(q) || cnt.includes(q);
  }

  function typePill(run){
    const t = (run.type || "").toLowerCase();
    if (t === "credit") return `<span class="typePill good">Credit</span>`;
    if (t === "debit") return `<span class="typePill bad">Debit</span>`;
    return `<span class="typePill">—</span>`;
  }

  function amountCell(run){
    const t = (run.type || "").toLowerCase();
    const amt = Number(run.amount || 0);
    const sign = (t === "debit") ? "-" : "+";
    const cls = (t === "debit") ? "amtBad" : "amtGood";
    return `<span class="${cls}">${sign} ${fmtMoney(Math.abs(amt))}</span>`;
  }

  function render(){
    clearErr();
    const list = allRuns
      .filter(r => withinRange(r.createdAt))
      .filter(r => matchesSearch(r));

    if (!list.length){
      rows.innerHTML = `<tr><td colspan="5" style="padding:14px;color:#64748b;">No statement entries for selected range.</td></tr>`;
      return;
    }

    rows.innerHTML = list.map(r => `
      <tr>
        <td>${fmtTime(r.createdAt)}</td>
        <td>${typePill(r)}</td>
        <td>${r.description || r.reason || "—"}</td>
        <td class="mono">${r.accountsCount ?? "—"}</td>
        <td>${amountCell(r)}</td>
      </tr>
    `).join("");
  }

  // Range pills
  document.querySelectorAll("#rangePills .pill").forEach(p=>{
    p.onclick = ()=>{
      document.querySelectorAll("#rangePills .pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");

      const range = p.dataset.range;
      const now = new Date();
      const start = new Date(now);

      if (range === "3m") start.setMonth(start.getMonth() - 3);
      if (range === "6m") start.setMonth(start.getMonth() - 6);

      if (range === "all"){
        fromDate.value = "";
        toDate.value = "";
        render();
        return;
      }

      const yyyy = start.getFullYear();
      const mm = String(start.getMonth()+1).padStart(2,"0");
      const dd = String(start.getDate()).padStart(2,"0");
      fromDate.value = `${yyyy}-${mm}-${dd}`;

      const y2 = now.getFullYear();
      const m2 = String(now.getMonth()+1).padStart(2,"0");
      const d2 = String(now.getDate()).padStart(2,"0");
      toDate.value = `${y2}-${m2}-${d2}`;
      render();
    };
  });

  fromDate.onchange = render;
  toDate.onchange = render;
  miniSearch.oninput = render;

  // Load wallet header
  async function loadHeader(){
    try{
      // skeleton-like values
      balEl.textContent = "₹ —";
      creditsEl.textContent = "₹ —";
      debitsEl.textContent = "₹ —";
      netEl.textContent = "₹ —";
      rateLine.textContent = "Rate: ₹ — / account";

      const w = await getDoc(doc(db, "wallets", sess.uid));
      const wallet = w.exists() ? w.data() : { balance:0, creditsTotal:0, debitsTotal:0 };

      balEl.textContent = fmtMoney(wallet.balance || 0);
      creditsEl.textContent = fmtMoney(wallet.creditsTotal || 0);
      debitsEl.textContent = fmtMoney(wallet.debitsTotal || 0);
      netEl.textContent = fmtMoney((wallet.creditsTotal||0) - (wallet.debitsTotal||0));

      const r = await getDoc(doc(db, "rates", sess.uid));
      const rate = r.exists() ? (r.data().ratePerAccount ?? "—") : "—";
      rateLine.textContent = `Rate: ₹ ${rate} / account`;
    }catch(e){
      showErr("Cannot load wallet: " + e.message);
    }
  }

  // Listen statement
  function listenRuns(){
    setSkeleton();

    const qy = query(collection(db, "wallets", sess.uid, "runs"), orderBy("createdAt", "desc"));
    onSnapshot(qy, (snap)=>{
      allRuns = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      render();
    }, (e)=>{
      showErr("Cannot load statement: " + e.message);
    });
  }

  // Downloads
  function getFiltered(){
    return allRuns
      .filter(r => withinRange(r.createdAt))
      .filter(r => matchesSearch(r));
  }

  function downloadFile(name, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 800);
  }

  document.getElementById("downloadCSV").onclick = ()=>{
    const list = getFiltered();
    const lines = ["Date,Type,Description,Accounts,Amount"];
    for (const r of list){
      const d = fmtTime(r.createdAt).replace(/,/g," ");
      const t = (r.type||"").toUpperCase();
      const desc = (r.description || r.reason || "").replace(/"/g,'""');
      const cnt = (r.accountsCount ?? "");
      const amt = (r.amount ?? "");
      lines.push(`"${d}","${t}","${desc}","${cnt}","${amt}"`);
    }
    downloadFile("wallet_statement.csv", lines.join("\n"));
  };

  document.getElementById("downloadTXT").onclick = ()=>{
    const list = getFiltered();
    const lines = [];
    lines.push("BUCKUP-MEDIA WALLET STATEMENT");
    lines.push("----------------------------------------");
    for (const r of list){
      const d = fmtTime(r.createdAt);
      const t = (r.type||"").toUpperCase();
      const desc = (r.description || r.reason || "");
      const cnt = (r.accountsCount ?? "—");
      const amt = r.amount ?? 0;
      lines.push(`${d} | ${t} | ${desc} | Accounts: ${cnt} | Amount: ${amt}`);
    }
    downloadFile("wallet_statement.txt", lines.join("\n"));
  };

  // ===== Hover parallax (subtle) =====
  function initTilt(){
    const cards = document.querySelectorAll("[data-tilt]");
    cards.forEach(card=>{
      card.addEventListener("mousemove", (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width - 0.5;
        const y = (e.clientY - r.top) / r.height - 0.5;
        card.style.transform = `perspective(900px) rotateX(${(-y*3).toFixed(2)}deg) rotateY(${(x*3).toFixed(2)}deg) translateY(-2px)`;
      });
      card.addEventListener("mouseleave", ()=>{
        card.style.transform = `perspective(900px) rotateX(0deg) rotateY(0deg) translateY(0px)`;
      });
    });
  }

  // Init
  loadHeader();
  listenRuns();
  initTilt();
</script>

</body>
</html>
