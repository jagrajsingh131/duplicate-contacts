<!DOCTYPE html>
<html>
<head>
  <title>My Account | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body>

<div class="card card-lg">
  <div class="brand">My Account</div>
  <div class="sub">View / Edit your details</div>

  <form id="accForm">
    <label>Name</label>
    <input id="name" required>

    <label>Phone</label>
    <input id="phone" required>

    <label>Age</label>
    <input id="age" type="number" required>

    <label>Google Sheet Link</label>
    <input id="sheet" required>

    <div class="btnRow">
      <button class="primary" type="submit">Save Changes</button>
      <button class="ghost" type="button" id="back">Back</button>
    </div>

    <div id="ok" class="msg ok"></div>
    <div id="er" class="msg err"></div>
  </form>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getSession, getProfileLocal, saveProfileLocal } from "./cache.js";

  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ ok.style.display="block"; er.style.display="none"; ok.textContent=t; };
  const showEr = (t)=>{ er.style.display="block"; ok.style.display="none"; er.textContent=t; };

  const sess = getSession();
  if (!sess) location.href = "index.html";

  const nameEl = document.getElementById("name");
  const phoneEl = document.getElementById("phone");
  const ageEl = document.getElementById("age");
  const sheetEl = document.getElementById("sheet");

  let uid = null;

  function sanitize(obj){
    const clean = {};
    for (const k in obj) if (obj[k] !== undefined) clean[k] = obj[k];
    return clean;
  }

  onAuthStateChanged(auth, user => {
    if (!user || !user.emailVerified) location.href = "index.html";
    uid = user.uid;

    const p = getProfileLocal();
    if (p) {
      nameEl.value = p.name || "";
      phoneEl.value = p.phone || "";
      ageEl.value = p.age ?? "";
      sheetEl.value = p.googleSheetUrl || "";
    }
  });

  document.getElementById("accForm").addEventListener("submit", (e) => {
    e.preventDefault();

    const profileData = {
      name: nameEl.value.trim(),
      phone: phoneEl.value.trim(),
      age: Number(ageEl.value),
      googleSheetUrl: sheetEl.value.trim(),
      profileCompleted: true
    };

    saveProfileLocal(profileData);
    setDoc(doc(db, "users", uid), sanitize(profileData), { merge: true }).catch(console.warn);

    showOk("Saved locally âœ…");
  });

  document.getElementById("back").onclick = () => location.href = "home.html";
</script>

</body>
</html>
