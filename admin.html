<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body class="adminShell">

  <aside class="sideNav">
    <div class="sideTop">
      <div class="sideLogo">BM</div>
      <div>
        <div class="sideName">Buckup-Media</div>
        <div class="sideSub">Admin Panel</div>
      </div>
    </div>

    <nav class="sideMenu">
      <button class="navItem" id="goHome">Home</button>
      <button class="navItem" id="goWallet">Wallet</button>
      <button class="navItem" id="goAccounts">Accounts</button>
      <button class="navItem active">Admin</button>
    </nav>

    <div class="sideBottom">
      <div class="sideHint">Admin only</div>
      <div class="sideSmall">© Buckup-Media</div>
    </div>
  </aside>

  <div class="mainArea">
    <header class="topBar">
      <div>
        <div class="topTitle">Admin</div>
        <div class="topSub">Set user payout rate • Manage users</div>
      </div>
      <div class="topRight">
        <span class="chip">Admin</span>
        <button class="toolBtn ghost" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <main class="content">
      <section class="page show">

        <div class="cardX">
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Set User Rate (₹ per account)</div>
              <div class="cardXSub">This controls wallet credit/deduction calculations</div>
            </div>
          </div>

          <div class="adminForm">
            <div>
              <div class="toolLabel">User UID</div>
              <input id="uid" class="toolInput" placeholder="Paste user UID">
            </div>

            <div>
              <div class="toolLabel">Rate per account (₹)</div>
              <input id="rate" class="toolInput" type="number" placeholder="e.g. 10">
            </div>

            <div class="adminFormBtns">
              <button class="toolBtn primary" id="saveRate">Save Rate</button>
              <button class="toolBtn ghost" id="loadRate">Load Current</button>
            </div>
          </div>

          <div id="ok" class="toolMsg ok"></div>
          <div id="er" class="toolMsg err"></div>
        </div>

        <div class="cardX" style="margin-top:16px;">
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Quick View</div>
              <div class="cardXSub">Admins can paste UID from Firebase Auth users list</div>
            </div>
          </div>

          <div class="toolHint">
            Tip: Firebase Console → Authentication → Users → copy UID.
          </div>
        </div>

      </section>
    </main>
  </div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getSession } from "./cache.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const sess = getSession();
  if (!sess) location.href = "index.html";

  document.getElementById("goHome").onclick = ()=> location.href = "home.html";
  document.getElementById("goWallet").onclick = ()=> {
    sessionStorage.setItem("bm_wallet_sound","1");
    location.href = "wallet.html";
  };
  document.getElementById("goAccounts").onclick = ()=> location.href = "accounts.html";
  document.getElementById("refreshBtn").onclick = ()=> location.reload();

  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ ok.style.display="block"; er.style.display="none"; ok.textContent=t; };
  const showEr = (t)=>{ er.style.display="block"; ok.style.display="none"; er.textContent=t; };

  // Admin check: requires /admins/{uid} document exists = true
  onAuthStateChanged(auth, async (user) => {
    if (!user || !user.emailVerified) location.href = "index.html";
    try{
      const a = await getDoc(doc(db, "admins", user.uid));
      if (!a.exists()) location.href = "home.html";
    }catch{
      location.href = "home.html";
    }
  });

  const uidEl = document.getElementById("uid");
  const rateEl = document.getElementById("rate");

  document.getElementById("loadRate").onclick = async ()=>{
    ok.style.display="none"; er.style.display="none";
    const uid = uidEl.value.trim();
    if (!uid) return showEr("Paste UID first.");
    try{
      const r = await getDoc(doc(db, "rates", uid));
      rateEl.value = r.exists() ? (r.data().ratePerAccount ?? "") : "";
      showOk("Loaded ✅");
    }catch(e){
      showEr(e.message);
    }
  };

  document.getElementById("saveRate").onclick = async ()=>{
    ok.style.display="none"; er.style.display="none";
    const uid = uidEl.value.trim();
    const rate = Number(rateEl.value);
    if (!uid) return showEr("UID required.");
    if (!Number.isFinite(rate) || rate < 0) return showEr("Enter a valid rate.");

    try{
      await setDoc(doc(db, "rates", uid), { ratePerAccount: rate }, { merge:true });
      showOk("Saved ✅ Rate updated.");
    }catch(e){
      showEr("Save failed: " + e.message);
    }
  };
</script>

</body>
</html>
