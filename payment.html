<!DOCTYPE html>
<html>
<head>
  <title>Payment | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body>

<div class="card card-lg">
  <div class="brand">Payment Details</div>
  <div class="sub">Fill once. After saving, edits are locked.</div>

  <form id="payForm">
    <label>Account Holder Name</label>
    <input id="holder" required>

    <label>Account Number</label>
    <input id="accno" required>

    <label>Bank Name</label>
    <input id="bank" required>

    <label>IFSC</label>
    <input id="ifsc" required>

    <label>Branch</label>
    <input id="branch" required>

    <label>UPI ID</label>
    <input id="upi" required placeholder="example@upi">

    <div class="btnRow">
      <button class="primary" type="submit" id="saveBtn">Save</button>
      <button class="ghost" type="button" id="back">Back</button>
      <button class="info" type="button" id="reqBtn" style="display:none;">Request details change</button>
    </div>

    <div id="ok" class="msg ok"></div>
    <div id="er" class="msg err"></div>
  </form>
</div>

<script type="module">
  import { auth } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getSession, getPaymentLocal, savePaymentLocal } from "./cache.js";

  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ ok.style.display="block"; er.style.display="none"; ok.textContent=t; };
  const showEr = (t)=>{ er.style.display="block"; ok.style.display="none"; er.textContent=t; };

  const sess = getSession();
  if (!sess) location.href = "index.html";

  const reqBtn = document.getElementById("reqBtn");
  const saveBtn = document.getElementById("saveBtn");

  function setLocked(locked) {
    ["holder","accno","bank","ifsc","branch","upi"].forEach(id => {
      document.getElementById(id).disabled = locked;
    });
    saveBtn.style.display = locked ? "none" : "inline-block";
    reqBtn.style.display = locked ? "inline-block" : "none";
  }

  function adminAllowedEdit() {
    // local unlock flag set by admin page
    const v = localStorage.getItem(`bm_${sess.uid}_payment_edit_allowed`);
    return v === "1";
  }

  onAuthStateChanged(auth, user => {
    if (!user || !user.emailVerified) location.href = "index.html";

    const p = getPaymentLocal();
    if (p) {
      holder.value = p.holder || "";
      accno.value = p.accno || "";
      bank.value = p.bank || "";
      ifsc.value = p.ifsc || "";
      branch.value = p.branch || "";
      upi.value = p.upi || "";
    }

    // Lock if already saved once AND admin not allowed
    if (p?.locked === true && !adminAllowedEdit()) {
      setLocked(true);
    } else {
      setLocked(false);
    }
  });

  document.getElementById("payForm").addEventListener("submit", (e) => {
    e.preventDefault();

    const payment = {
      holder: holder.value.trim(),
      accno: accno.value.trim(),
      bank: bank.value.trim(),
      ifsc: ifsc.value.trim(),
      branch: branch.value.trim(),
      upi: upi.value.trim(),
      locked: true, // lock after first save
      requestedChange: false
    };

    savePaymentLocal(payment);
    showOk("Saved ✅ Payment locked now.");
    setLocked(true);
  });

  reqBtn.onclick = () => {
    const p = getPaymentLocal() || {};
    p.requestedChange = true;
    savePaymentLocal(p);
    showOk("Request sent ✅ Admin will review.");
  };

  document.getElementById("back").onclick = () => location.href = "home.html";
</script>

</body>
</html>
