<!DOCTYPE html>
<html>
<head>
  <title>Profile Setup</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body>

<div class="card card-lg">
  <div class="brand">Complete Your Profile</div>
  <div class="sub">One-time setup (this page will not show again)</div>

  <form id="profileForm">
    <label>Name</label>
    <input id="name" required>

    <label>Phone</label>
    <input id="phone" required>

    <label>Age</label>
    <input id="age" type="number" required>

    <label>Google Sheet Link</label>
    <input id="sheet" required>

    <label>Choose Avatar</label>
    <div class="avatarGrid" id="avatarGrid"></div>

    <div id="progressWrap" style="display:none;margin-top:14px;">
      <div class="small" id="progressText">Preparing...</div>
      <div style="height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden;">
        <div id="progressBar" style="height:12px;width:0%;background:linear-gradient(90deg,#4f46e5,#22c55e);"></div>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="saveBtn">Save & Continue</button>
    </div>

    <div id="er" class="msg err"></div>
  </form>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getSession, getProfileLocal, saveProfileLocal } from "./cache.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const bar = document.getElementById("progressBar");
  const txt = document.getElementById("progressText");
  const wrap = document.getElementById("progressWrap");
  const err = document.getElementById("er");

  const nameEl = document.getElementById("name");
  const phoneEl = document.getElementById("phone");
  const ageEl = document.getElementById("age");
  const sheetEl = document.getElementById("sheet");

  const sess = getSession();
  if (!sess) location.href = "index.html";

  let uid = null;

  // Dummy AI avatar URLs (you can replace later)
  const avatarList = [
    "https://api.dicebear.com/9.x/bottts/svg?seed=Buckup1",
    "https://api.dicebear.com/9.x/bottts/svg?seed=Buckup2",
    "https://api.dicebear.com/9.x/bottts/svg?seed=Buckup3",
    "https://api.dicebear.com/9.x/bottts/svg?seed=Buckup4",
    "https://api.dicebear.com/9.x/bottts/svg?seed=Buckup5",
    "https://api.dicebear.com/9.x/bottts/svg?seed=Buckup6"
  ];

  let selectedAvatar = avatarList[0];

  function showProgress(msg, pct) {
    wrap.style.display = "block";
    txt.textContent = msg;
    bar.style.width = pct + "%";
  }

  function sanitize(obj) {
    const clean = {};
    for (const k in obj) if (obj[k] !== undefined) clean[k] = obj[k];
    return clean;
  }

  function renderAvatars(activeUrl) {
    const grid = document.getElementById("avatarGrid");
    grid.innerHTML = "";
    avatarList.forEach((url) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "avatarPick" + (url === activeUrl ? " active" : "");
      btn.innerHTML = `<img src="${url}" alt="avatar">`;
      btn.onclick = () => {
        selectedAvatar = url;
        renderAvatars(url);
      };
      grid.appendChild(btn);
    });
  }

  onAuthStateChanged(auth, user => {
    if (!user) location.href = "index.html";
    if (!user.emailVerified) location.href = "index.html";
    uid = user.uid;

    const cached = getProfileLocal();

    // âœ… RULE 1: If profile already completed, never open profile setup again
    if (cached?.profileCompleted === true) {
      location.href = "home.html";
      return;
    }

    // preload if exists
    if (cached) {
      nameEl.value = cached.name || "";
      phoneEl.value = cached.phone || "";
      ageEl.value = cached.age ?? "";
      sheetEl.value = cached.googleSheetUrl || "";
      if (cached.avatarUrl) selectedAvatar = cached.avatarUrl;
    }

    renderAvatars(selectedAvatar);
  });

  document.getElementById("profileForm").addEventListener("submit", async e => {
    e.preventDefault();
    err.style.display = "none";

    try {
      showProgress("Saving locally...", 60);

      const profileData = {
        name: nameEl.value.trim(),
        phone: phoneEl.value.trim(),
        age: Number(ageEl.value),
        googleSheetUrl: sheetEl.value.trim(),
        avatarUrl: selectedAvatar,
        profileCompleted: true
      };

      saveProfileLocal(profileData);

      showProgress("Finalizing...", 100);

      // cloud backup optional
      setDoc(doc(db, "users", uid), sanitize(profileData), { merge: true }).catch(console.warn);

      location.href = "home.html";

    } catch (e2) {
      err.style.display = "block";
      err.textContent = e2.message;
    }
  });
</script>

</body>
</html>
