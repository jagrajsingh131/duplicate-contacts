<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Complete Profile | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="card" style="max-width:720px">
    <div class="brand">Complete Your Profile</div>
    <div class="sub">First-time setup. After this you’ll go to dashboard.</div>

    <form id="profileForm">
      <div class="row">
        <div>
          <label>Name</label>
          <input id="name" required>
        </div>
        <div>
          <label>Email</label>
          <input id="email" disabled>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Phone</label>
          <input id="phone" required>
        </div>
        <div>
          <label>Age</label>
          <input id="age" type="number" min="1" max="120" required placeholder="e.g. 23">
        </div>
      </div>

      <label>Google Sheet Link (required)</label>
      <input id="sheet" required placeholder="https://docs.google.com/spreadsheets/d/...">

      <label>Profile Photo (optional)</label>
      <input id="photo" type="file" accept="image/*">

      <label>Use Type (recommended)</label>
      <select id="useType">
        <option value="personal">Personal</option>
        <option value="business">Business</option>
        <option value="agency">Agency</option>
      </select>

      <div class="btnRow">
        <button class="primary" type="submit" id="saveBtn">Save & Continue</button>
        <button class="ghost" type="button" onclick="window.location.href='index.html'">Back</button>
      </div>

      <div id="ok" class="msg ok"></div>
      <div id="er" class="msg err"></div>
      <div class="footer">Buckup-Media • Profile stored securely</div>
    </form>
  </div>

<script type="module">
  import { auth, db, storage } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ok.style.display="block";er.style.display="none";ok.textContent=t;}
  const showEr = (t)=>{er.style.display="block";ok.style.display="none";er.textContent=t;}

  let currentUID = null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user || !user.emailVerified){
      window.location.href = "index.html";
      return;
    }

    currentUID = user.uid;
    document.getElementById("email").value = user.email;

    const snap = await getDoc(doc(db, "users", user.uid));
    if(snap.exists()){
      const d = snap.data();
      document.getElementById("name").value = d.name || "";
      document.getElementById("phone").value = d.phone || "";
      document.getElementById("age").value = d.age || "";
      document.getElementById("sheet").value = d.googleSheetUrl || "";
      document.getElementById("useType").value = d.useType || "personal";

      // If profile already completed, go dashboard
      if(d.profileCompleted === true){
        window.location.href = "dashboard.html";
      }
    }
  });

  document.getElementById("profileForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!currentUID) return;

    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true;
    saveBtn.textContent = "Saving...";

    try{
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const age = Number(document.getElementById("age").value);
      const sheet = document.getElementById("sheet").value.trim();
      const useType = document.getElementById("useType").value;
      const photoFile = document.getElementById("photo").files[0];

      // simple validation for google sheet link
      if(!sheet.includes("docs.google.com/spreadsheets")){
        throw new Error("Please paste a valid Google Sheets link.");
      }

      let photoURL = "";

      // upload photo if exists
      if(photoFile){
        const path = `profile_photos/${currentUID}/${Date.now()}_${photoFile.name}`;
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, photoFile);
        photoURL = await getDownloadURL(storageRef);
      }

      const payload = {
        name,
        phone,
        age,
        useType,
        googleSheetUrl: sheet,
        profileCompleted: true
      };

      if(photoURL) payload.photoURL = photoURL;

      await updateDoc(doc(db, "users", currentUID), payload);

      showOk("Profile saved ✅ Redirecting to dashboard...");
      setTimeout(()=>window.location.href="dashboard.html", 900);

    }catch(err){
      showEr((err.code||"error")+" : "+(err.message||err));
      console.error(err);
    }finally{
      saveBtn.disabled = false;
      saveBtn.textContent = "Save & Continue";
    }
  });
</script>
</body>
</html>
