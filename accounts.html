<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accounts | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body class="toolBody">

<header class="toolTop">
  <div class="toolBrand">
    <div class="toolLogo">BM</div>
    <div>
      <div class="toolTitle">Accounts</div>
      <div class="toolSub">Shared list • Tags • Details</div>
    </div>
  </div>

  <div class="toolActions">
    <button class="toolBtn ghost" id="homeBtn">Home</button>
    <button class="toolBtn primary" id="openAdd">Add More Accounts</button>
  </div>
</header>

<main class="toolMain">

  <section class="toolCard">
    <div class="toolCardHead" style="align-items:flex-end;">
      <div>
        <div class="toolCardTitle">All Accounts</div>
        <div class="toolCardSub">This list is shared for all users</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <input id="search" class="toolInput" style="min-width:260px" placeholder="Search by name / number / tag">
        <button class="toolBtn ghost" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <!-- ✅ FILTER BAR -->
    <div class="accFilters">
      <div class="accFilt">
        <label class="toolLabel">Tag</label>
        <select id="tagFilter" class="toolInput">
          <option value="">All</option>
          <option value="locked">locked</option>
          <option value="cod issue">cod issue</option>
          <option value="incorrect password">incorrect password</option>
          <option value="__none__">No tag</option>
        </select>
      </div>

      <div class="accFilt">
        <label class="toolLabel">Created By</label>
        <select id="userFilter" class="toolInput">
          <option value="">All users</option>
        </select>
      </div>

      <div class="accFilt">
        <label class="toolLabel">From</label>
        <input id="fromDate" type="date" class="toolInput">
      </div>

      <div class="accFilt">
        <label class="toolLabel">To</label>
        <input id="toDate" type="date" class="toolInput">
      </div>

      <div class="accFilt accFiltBtns">
        <button class="toolBtn ghost" id="clearFilters">Clear Filters</button>
      </div>
    </div>

    <div id="ok" class="toolMsg ok"></div>
    <div id="er" class="toolMsg err"></div>

    <div class="accTableWrap" style="margin-top:14px;">
      <table class="accTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Tag</th>
            <th>Created By</th>
            <th>Added</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" style="padding:14px;color:#64748b;">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="toolHint" style="margin-top:10px;">
      Click any row to open <b>Account Details</b> and <b>Add Tag</b>.
    </div>
  </section>
</main>

<!-- ADD MODAL -->
<div class="modalBack" id="addModal" style="display:none;">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div class="toolCardTitle">Add More Accounts</div>
        <div class="toolCardSub">Paste like: <b>Name[TAB]Phone</b> (one per line)</div>
      </div>
      <button class="toolBtn ghost" id="closeAdd">Close</button>
    </div>

    <textarea id="pasteBox" class="toolArea" rows="10"
      placeholder="Example:
Dhananjay Butala	9884155629
Kajal Shenoy	8438525192"></textarea>

    <div class="toolHint">
      ✅ Supports TAB or spaces. <b>Phone must be last digits</b> in the line.
      Names can contain double spaces and will stay correct.
    </div>

    <div class="btnRow" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="toolBtn primary" id="saveAccounts">Save Accounts</button>
      <button class="toolBtn ghost" id="clearPaste">Clear</button>
    </div>

    <div id="addMsg" class="toolMsg ok"></div>
    <div id="addErr" class="toolMsg err"></div>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="modalBack" id="detailModal" style="display:none;">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div class="toolCardTitle">Account Details</div>
        <div class="toolCardSub" id="detailSub">—</div>
      </div>
      <button class="toolBtn ghost" id="closeDetail">Close</button>
    </div>

    <div class="detailBox">
      <div class="dRow"><span>Name</span><b id="dName">—</b></div>
      <div class="dRow"><span>Phone</span><b id="dPhone">—</b></div>
      <div class="dRow"><span>Created At</span><b id="dCreated">—</b></div>
      <div class="dRow"><span>Added By</span><b id="dBy">—</b></div>
      <div class="dRow"><span>Current Tag</span><b id="dTag">—</b></div>

      <hr style="border:none;border-top:1px solid #e2e8f0;margin:12px 0;">

      <label class="toolLabel">Set Tag</label>
      <select id="tagSelect" class="toolInput">
        <option value="">No tag</option>
        <option value="locked">locked</option>
        <option value="cod issue">cod issue</option>
        <option value="incorrect password">incorrect password</option>
      </select>

      <div class="btnRow" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="toolBtn primary" id="saveTag">Save Tag</button>
        <button class="toolBtn info" id="copyPhone">Copy Phone</button>
      </div>

      <div id="detailOk" class="toolMsg ok"></div>
      <div id="detailEr" class="toolMsg err"></div>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getSession, getProfileLocal } from "./cache.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot, doc, getDoc, setDoc, updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // UI messages
  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ ok.style.display="block"; er.style.display="none"; ok.textContent=t; };
  const showEr = (t)=>{ er.style.display="block"; ok.style.display="none"; er.textContent=t; };

  const rows = document.getElementById("rows");
  const search = document.getElementById("search");

  // filters
  const tagFilter = document.getElementById("tagFilter");
  const userFilter = document.getElementById("userFilter");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");

  // session check
  const sess = getSession();
  if (!sess) location.href = "index.html";

  onAuthStateChanged(auth, (user) => {
    if (!user || !user.emailVerified) location.href = "index.html";
  });

  document.getElementById("homeBtn").onclick = () => location.href = "home.html";

  let allAccounts = [];
  let unsubscribe = null;

  function fmtTime(ts){
    try{
      if (!ts) return "—";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }catch{ return "—"; }
  }

  function dateOnly(ts){
    try{
      if (!ts) return null;
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }catch{ return null; }
  }

  function badge(tag){
    const t = (tag || "").trim();
    if (!t) return `<span class="tagBadge none">No tag</span>`;
    if (t === "locked") return `<span class="tagBadge locked">locked</span>`;
    if (t === "cod issue") return `<span class="tagBadge cod">cod issue</span>`;
    if (t === "incorrect password") return `<span class="tagBadge pass">incorrect password</span>`;
    return `<span class="tagBadge other">${t}</span>`;
  }

  function render(list){
    if (!list.length){
      rows.innerHTML = `<tr><td colspan="5" style="padding:14px;color:#64748b;">No accounts match.</td></tr>`;
      return;
    }
    rows.innerHTML = list.map(a => `
      <tr class="accRow" data-id="${a.id}">
        <td>${(a.name || "—")}</td>
        <td class="mono">${a.phone || a.id}</td>
        <td>${badge(a.tag)}</td>
        <td>${(a.createdByName || "—")}</td>
        <td>${fmtTime(a.createdAt)}</td>
      </tr>
    `).join("");

    document.querySelectorAll(".accRow").forEach(tr=>{
      tr.onclick = ()=> openDetails(tr.dataset.id);
    });
  }

  function fillUserFilter(){
    const names = new Set();
    allAccounts.forEach(a => {
      if (a.createdByName) names.add(a.createdByName);
    });
    const current = userFilter.value;

    userFilter.innerHTML = `<option value="">All users</option>` +
      Array.from(names).sort().map(n => `<option value="${n}">${n}</option>`).join("");

    userFilter.value = current; // keep selection if possible
  }

  function applyFilters(){
    const q = search.value.trim().toLowerCase();
    const t = tagFilter.value;
    const u = userFilter.value;

    const from = fromDate.value || "";
    const to = toDate.value || "";

    const filtered = allAccounts.filter(a => {
      const name = (a.name || "").toLowerCase();
      const phone = (a.phone || a.id || "").toLowerCase();
      const tag = (a.tag || "").toLowerCase();
      const by = (a.createdByName || "");

      // search
      if (q && !(name.includes(q) || phone.includes(q) || tag.includes(q))) return false;

      // tag filter
      if (t === "__none__") {
        if ((a.tag || "").trim() !== "") return false;
      } else if (t) {
        if ((a.tag || "").trim() !== t) return false;
      }

      // user filter
      if (u && by !== u) return false;

      // date filter
      const d = dateOnly(a.createdAt);
      if (from && d && d < from) return false;
      if (to && d && d > to) return false;
      // if createdAt missing, keep it unless date filters are strict:
      if ((from || to) && !d) return false;

      return true;
    });

    render(filtered);
  }

  function startListener(){
    if (unsubscribe) unsubscribe();
    const qy = query(collection(db, "accounts"), orderBy("createdAt", "desc"));
    unsubscribe = onSnapshot(qy, (snap)=>{
      allAccounts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      fillUserFilter();
      applyFilters();
    }, (e)=>{
      showEr("Cannot load accounts: " + e.message);
    });
  }

  startListener();

  search.addEventListener("input", applyFilters);
  tagFilter.addEventListener("change", applyFilters);
  userFilter.addEventListener("change", applyFilters);
  fromDate.addEventListener("change", applyFilters);
  toDate.addEventListener("change", applyFilters);

  document.getElementById("clearFilters").onclick = () => {
    search.value = "";
    tagFilter.value = "";
    userFilter.value = "";
    fromDate.value = "";
    toDate.value = "";
    applyFilters();
  };

  document.getElementById("refreshBtn").onclick = () => { showOk("Refreshed ✅"); startListener(); };

  // Add Modal
  const addModal = document.getElementById("addModal");
  const pasteBox = document.getElementById("pasteBox");
  const addMsg = document.getElementById("addMsg");
  const addErr = document.getElementById("addErr");

  const showAddOk = (t)=>{ addMsg.style.display="block"; addErr.style.display="none"; addMsg.textContent=t; };
  const showAddEr = (t)=>{ addErr.style.display="block"; addMsg.style.display="none"; addErr.textContent=t; };

  document.getElementById("openAdd").onclick = ()=>{
    addModal.style.display="flex";
    addMsg.style.display="none";
    addErr.style.display="none";
  };
  document.getElementById("closeAdd").onclick = ()=> addModal.style.display="none";
  document.getElementById("clearPaste").onclick = ()=> pasteBox.value = "";

  // ✅ NEW parser: phone is LAST digits, name is everything before it (keeps spaces)
  function parseAccounts(text){
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    const out = [];

    for (const raw of lines){
      const line = raw.replace(/\r/g,""); // safe
      const m = line.match(/(\d{6,})\s*$/); // last digits at end
      if (!m) continue;

      const phone = m[1].replace(/\D/g,"");
      if (!phone) continue;

      const name = line.slice(0, m.index).trim(); // keep inner spacing
      if (!name) continue;

      out.push({ name, phone });
    }
    return out;
  }

  document.getElementById("saveAccounts").onclick = async ()=>{
    addMsg.style.display="none";
    addErr.style.display="none";

    const items = parseAccounts(pasteBox.value);
    if (!items.length) return showAddEr("No valid accounts found. Make sure phone is last digits in each line.");

    const prof = getProfileLocal() || {};
    const createdByName = prof.name || "—";
    const createdByEmail = sess.email || "—";

    let added = 0, skipped = 0;

    for (const it of items){
      const id = it.phone; // shared unique key by phone
      const ref = doc(db, "accounts", id);

      try{
        const existing = await getDoc(ref);
        if (existing.exists()){
          skipped++;
          continue;
        }

        await setDoc(ref, {
          name: it.name,
          phone: it.phone,
          tag: "",
          createdAt: serverTimestamp(),
          createdByUid: sess.uid,
          createdByEmail,
          createdByName,
          updatedAt: serverTimestamp(),
          updatedByUid: sess.uid,
          updatedByEmail: createdByEmail
        });

        added++;
      }catch(e){
        console.warn("Add fail", it, e);
      }
    }

    showAddOk(`Saved ✅ Added: ${added} | Skipped (already exists): ${skipped}`);
    pasteBox.value = "";
  };

  // Details + Tag update
  const detailModal = document.getElementById("detailModal");
  const detailOk = document.getElementById("detailOk");
  const detailEr = document.getElementById("detailEr");

  const showDetOk = (t)=>{ detailOk.style.display="block"; detailEr.style.display="none"; detailOk.textContent=t; };
  const showDetEr = (t)=>{ detailEr.style.display="block"; detailOk.style.display="none"; detailEr.textContent=t; };

  let currentId = null;

  async function openDetails(id){
    currentId = id;
    detailOk.style.display="none";
    detailEr.style.display="none";
    document.getElementById("detailSub").textContent = `Account: ${id}`;

    try{
      const snap = await getDoc(doc(db, "accounts", id));
      if (!snap.exists()) return showDetEr("Account not found.");

      const a = { id: snap.id, ...snap.data() };
      document.getElementById("dName").textContent = a.name || "—";
      document.getElementById("dPhone").textContent = a.phone || a.id;
      document.getElementById("dCreated").textContent = fmtTime(a.createdAt);
      document.getElementById("dBy").textContent = (a.createdByName || "—") + " • " + (a.createdByEmail || "—");
      document.getElementById("dTag").textContent = a.tag ? a.tag : "No tag";
      document.getElementById("tagSelect").value = a.tag || "";

      detailModal.style.display="flex";
    }catch(e){
      showDetEr("Cannot open details: " + e.message);
    }
  }

  document.getElementById("closeDetail").onclick = ()=> detailModal.style.display="none";

  document.getElementById("saveTag").onclick = async ()=>{
    if (!currentId) return;

    const tag = document.getElementById("tagSelect").value;
    try{
      await updateDoc(doc(db, "accounts", currentId), {
        tag,
        updatedAt: serverTimestamp(),
        updatedByUid: sess.uid,
        updatedByEmail: sess.email || "—"
      });
      showDetOk("Tag saved ✅ Visible to all users.");
    }catch(e){
      showDetEr("Tag save failed: " + e.message);
    }
  };

  document.getElementById("copyPhone").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(currentId || "");
      showDetOk("Phone copied ✅");
    }catch{
      showDetEr("Copy failed.");
    }
  };
</script>

</body>
</html>
