<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accounts | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body class="toolBody">

<header class="toolTop">
  <div class="toolBrand">
    <div class="toolLogo">BM</div>
    <div>
      <div class="toolTitle">Accounts</div>
      <div class="toolSub">Shared list • Tags • Details • Filters</div>
    </div>
  </div>

  <div class="toolActions">
    <button class="toolBtn ghost" id="homeBtn">Home</button>
    <button class="toolBtn primary" id="openAdd">Add More Accounts</button>
  </div>
</header>

<main class="toolMain">

  <section class="toolCard">
    <div class="toolCardHead">
      <div>
        <div class="toolCardTitle">All Accounts</div>
        <div class="toolCardSub">This list is shared for all users</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="toolBtn ghost" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="accFilters">
      <div class="toolField">
        <label class="toolLabel">Search</label>
        <input id="search" class="toolInput" placeholder="Search by name / phone / tag">
      </div>

      <div class="toolField">
        <label class="toolLabel">Tag</label>
        <select id="filterTag" class="toolInput">
          <option value="">All</option>
          <option value="locked">locked</option>
          <option value="cod issue">cod issue</option>
          <option value="incorrect password">incorrect password</option>
          <option value="__none__">No tag</option>
        </select>
      </div>

      <div class="toolField">
        <label class="toolLabel">Created By</label>
        <input id="filterUser" class="toolInput" placeholder="Type creator name/email">
      </div>

      <div class="toolField">
        <label class="toolLabel">Date From</label>
        <input id="dateFrom" class="toolInput" type="date">
      </div>

      <div class="toolField">
        <label class="toolLabel">Date To</label>
        <input id="dateTo" class="toolInput" type="date">
      </div>

      <div class="toolField" style="align-self:end;">
        <button class="toolBtn ghost" id="clearFilters" type="button">Clear Filters</button>
      </div>
    </div>

    <div id="ok" class="toolMsg ok"></div>
    <div id="er" class="toolMsg err"></div>

    <div class="accTableWrap" style="margin-top:14px;">
      <table class="accTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Tag</th>
            <th>Added</th>
            <th>Created By</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" style="padding:14px;color:#64748b;">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="toolHint" style="margin-top:10px;">
      Click any row to open <b>Account Details</b> and <b>Add Tag</b>.
    </div>
  </section>
</main>

<!-- ADD MODAL -->
<div class="modalBack" id="addModal" style="display:none;">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div class="toolCardTitle">Add More Accounts</div>
        <div class="toolCardSub">Paste like: <b>Name[TAB]Phone</b> (one per line)</div>
      </div>
      <button class="toolBtn ghost" id="closeAdd">Close</button>
    </div>

    <textarea id="pasteBox" class="toolArea" rows="10"
      placeholder="Example:
Dhananjay Butala	9884155629
Aravind  Rai	9517943292"></textarea>

    <div class="toolHint">
      ✅ Keeps name spacing exactly (even double spaces).  
      ✅ Phone is detected from the <b>end of the line</b>.
    </div>

    <div class="btnRow" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="toolBtn primary" id="saveAccounts">Save Accounts</button>
      <button class="toolBtn ghost" id="clearPaste">Clear</button>
    </div>

    <div id="addMsg" class="toolMsg ok"></div>
    <div id="addErr" class="toolMsg err"></div>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="modalBack" id="detailModal" style="display:none;">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div class="toolCardTitle">Account Details</div>
        <div class="toolCardSub" id="detailSub">—</div>
      </div>
      <button class="toolBtn ghost" id="closeDetail">Close</button>
    </div>

    <div class="detailBox">
      <div class="dRow"><span>Name</span><b id="dName">—</b></div>
      <div class="dRow"><span>Phone</span><b id="dPhone">—</b></div>
      <div class="dRow"><span>Created At</span><b id="dCreated">—</b></div>
      <div class="dRow"><span>Added By</span><b id="dBy">—</b></div>
      <div class="dRow"><span>Current Tag</span><b id="dTag">—</b></div>

      <hr style="border:none;border-top:1px solid #e2e8f0;margin:12px 0;">

      <label class="toolLabel">Set Tag</label>
      <select id="tagSelect" class="toolInput">
        <option value="">No tag</option>
        <option value="locked">locked</option>
        <option value="cod issue">cod issue</option>
        <option value="incorrect password">incorrect password</option>
      </select>

      <div class="btnRow" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="toolBtn primary" id="saveTag">Save Tag</button>
        <button class="toolBtn info" id="copyPhone">Copy Phone</button>
      </div>

      <div id="detailOk" class="toolMsg ok"></div>
      <div id="detailEr" class="toolMsg err"></div>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getSession, getProfileLocal } from "./cache.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot, doc, getDoc, setDoc, updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // UI messages
  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ ok.style.display="block"; er.style.display="none"; ok.textContent=t; };
  const showEr = (t)=>{ er.style.display="block"; ok.style.display="none"; er.textContent=t; };

  const rows = document.getElementById("rows");

  // filters
  const search = document.getElementById("search");
  const filterTag = document.getElementById("filterTag");
  const filterUser = document.getElementById("filterUser");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");

  // session check
  const sess = getSession();
  if (!sess) location.href = "index.html";

  onAuthStateChanged(auth, (user) => {
    if (!user || !user.emailVerified) location.href = "index.html";
  });

  document.getElementById("homeBtn").onclick = () => location.href = "home.html";

  let allAccounts = [];
  let unsubscribe = null;

  function fmtTime(ts){
    try{
      if (!ts) return "—";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }catch{ return "—"; }
  }
  function toDateObj(ts){
    try{
      if (!ts) return null;
      return ts.toDate ? ts.toDate() : new Date(ts);
    }catch{ return null; }
  }

  function badge(tag){
    const t = (tag || "").trim();
    if (!t) return `<span class="tagBadge none">No tag</span>`;
    if (t === "locked") return `<span class="tagBadge locked">locked</span>`;
    if (t === "cod issue") return `<span class="tagBadge cod">cod issue</span>`;
    if (t === "incorrect password") return `<span class="tagBadge pass">incorrect password</span>`;
    return `<span class="tagBadge other">${t}</span>`;
  }

  function render(list){
    if (!list.length){
      rows.innerHTML = `<tr><td colspan="5" style="padding:14px;color:#64748b;">No accounts match filters.</td></tr>`;
      return;
    }
    rows.innerHTML = list.map(a => {
      const creator = (a.createdByName || "—") + (a.createdByEmail ? ` • ${a.createdByEmail}` : "");
      return `
        <tr class="accRow" data-id="${a.id}">
          <td>${(a.name || "—")}</td>
          <td class="mono">${a.phone || a.id}</td>
          <td>${badge(a.tag)}</td>
          <td>${fmtTime(a.createdAt)}</td>
          <td>${creator}</td>
        </tr>
      `;
    }).join("");

    document.querySelectorAll(".accRow").forEach(tr=>{
      tr.onclick = ()=> openDetails(tr.dataset.id);
    });
  }

  function applyFilters(){
    const q = search.value.trim().toLowerCase();
    const tg = filterTag.value;
    const userQ = filterUser.value.trim().toLowerCase();

    const df = dateFrom.value ? new Date(dateFrom.value + "T00:00:00") : null;
    const dt = dateTo.value ? new Date(dateTo.value + "T23:59:59") : null;

    const filtered = allAccounts.filter(a => {
      const name = (a.name || "").toLowerCase();
      const phone = (a.phone || a.id || "").toLowerCase();
      const tag = (a.tag || "").toLowerCase();
      const creatorName = (a.createdByName || "").toLowerCase();
      const creatorEmail = (a.createdByEmail || "").toLowerCase();

      // search box
      if (q) {
        const okSearch = name.includes(q) || phone.includes(q) || tag.includes(q);
        if (!okSearch) return false;
      }

      // tag filter
      if (tg) {
        if (tg === "__none__") {
          if ((a.tag || "").trim() !== "") return false;
        } else {
          if ((a.tag || "").trim() !== tg) return false;
        }
      }

      // created by filter
      if (userQ) {
        const okUser = creatorName.includes(userQ) || creatorEmail.includes(userQ);
        if (!okUser) return false;
      }

      // date filter
      const created = toDateObj(a.createdAt);
      if (df && created && created < df) return false;
      if (dt && created && created > dt) return false;
      if ((df || dt) && !created) return false;

      return true;
    });

    render(filtered);
  }

  function startListener(){
    if (unsubscribe) unsubscribe();
    const qy = query(collection(db, "accounts"), orderBy("createdAt", "desc"));
    unsubscribe = onSnapshot(qy, (snap)=>{
      allAccounts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilters();
    }, (e)=>{
      showEr("Cannot load accounts: " + e.message);
    });
  }

  startListener();

  // hook filters
  [search, filterTag, filterUser, dateFrom, dateTo].forEach(el => {
    el.addEventListener("input", applyFilters);
    el.addEventListener("change", applyFilters);
  });

  document.getElementById("clearFilters").onclick = () => {
    search.value = "";
    filterTag.value = "";
    filterUser.value = "";
    dateFrom.value = "";
    dateTo.value = "";
    applyFilters();
    showOk("Filters cleared ✅");
  };

  document.getElementById("refreshBtn").onclick = () => { showOk("Refreshed ✅"); startListener(); };

  // Add Modal
  const addModal = document.getElementById("addModal");
  const pasteBox = document.getElementById("pasteBox");
  const addMsg = document.getElementById("addMsg");
  const addErr = document.getElementById("addErr");
  const showAddOk = (t)=>{ addMsg.style.display="block"; addErr.style.display="none"; addMsg.textContent=t; };
  const showAddEr = (t)=>{ addErr.style.display="block"; addMsg.style.display="none"; addErr.textContent=t; };

  document.getElementById("openAdd").onclick = ()=>{
    addModal.style.display="flex";
    addMsg.style.display="none";
    addErr.style.display="none";
  };
  document.getElementById("closeAdd").onclick = ()=> addModal.style.display="none";
  document.getElementById("clearPaste").onclick = ()=> pasteBox.value = "";

  // ✅ NEW PARSER: keeps name spacing, takes phone from end of line
  function parseAccounts(text){
    const lines = text.split(/\r?\n/);
    const out = [];

    for (let raw of lines){
      if (!raw) continue;
      // keep original spacing in name; only trim line edges
      const line = raw.replace(/\r/g, "").trim();
      if (!line) continue;

      // match phone digits at end (allow spaces/dashes inside at end, but capture digits)
      // example: "Aravind  Rai\t9517943292"
      const m = line.match(/(.*?)[\t ]+([0-9][0-9 \-]{5,}[0-9])\s*$/);
      if (!m) continue;

      const name = m[1]; // keeps internal spacing
      const phone = (m[2] || "").replace(/\D/g, "");

      if (!name || !phone) continue;

      out.push({ name, phone });
    }
    return out;
  }

  document.getElementById("saveAccounts").onclick = async ()=>{
    addMsg.style.display="none";
    addErr.style.display="none";

    const items = parseAccounts(pasteBox.value);
    if (!items.length) return showAddEr("No valid accounts found. Use: Name[TAB]Phone (phone at end).");

    const prof = getProfileLocal() || {};
    const createdByName = prof.name || "—";
    const createdByEmail = sess.email || "—";

    let added = 0, skipped = 0;

    for (const it of items){
      const id = it.phone; // phone as doc id
      const ref = doc(db, "accounts", id);

      try{
        const existing = await getDoc(ref);
        if (existing.exists()){
          skipped++;
          continue;
        }

        await setDoc(ref, {
          name: it.name,
          phone: it.phone,
          tag: "",
          createdAt: serverTimestamp(),
          createdByUid: sess.uid,
          createdByEmail,
          createdByName,
          updatedAt: serverTimestamp(),
          updatedByUid: sess.uid,
          updatedByEmail: createdByEmail
        });

        added++;
      }catch(e){
        console.warn("Add fail", it, e);
      }
    }

    showAddOk(`Saved ✅ Added: ${added} | Skipped (already exists): ${skipped}`);
    pasteBox.value = "";
  };

  // Details + Tag update
  const detailModal = document.getElementById("detailModal");
  const detailOk = document.getElementById("detailOk");
  const detailEr = document.getElementById("detailEr");
  const showDetOk = (t)=>{ detailOk.style.display="block"; detailEr.style.display="none"; detailOk.textContent=t; };
  const showDetEr = (t)=>{ detailEr.style.display="block"; detailOk.style.display="none"; detailEr.textContent=t; };

  let currentId = null;

  async function openDetails(id){
    currentId = id;
    detailOk.style.display="none";
    detailEr.style.display="none";
    document.getElementById("detailSub").textContent = `Account: ${id}`;

    try{
      const snap = await getDoc(doc(db, "accounts", id));
      if (!snap.exists()) return showDetEr("Account not found.");

      const a = { id: snap.id, ...snap.data() };
      document.getElementById("dName").textContent = a.name || "—";
      document.getElementById("dPhone").textContent = a.phone || a.id;
      document.getElementById("dCreated").textContent = fmtTime(a.createdAt);
      document.getElementById("dBy").textContent = (a.createdByName || "—") + " • " + (a.createdByEmail || "—");
      document.getElementById("dTag").textContent = a.tag ? a.tag : "No tag";
      document.getElementById("tagSelect").value = a.tag || "";
      detailModal.style.display="flex";
    }catch(e){
      showDetEr("Cannot open details: " + e.message);
    }
  }

  document.getElementById("closeDetail").onclick = ()=> detailModal.style.display="none";

  document.getElementById("saveTag").onclick = async ()=>{
    if (!currentId) return;
    const tag = document.getElementById("tagSelect").value;

    try{
      await updateDoc(doc(db, "accounts", currentId), {
        tag,
        updatedAt: serverTimestamp(),
        updatedByUid: sess.uid,
        updatedByEmail: sess.email || "—"
      });
      showDetOk("Tag saved ✅ Visible to all users.");
    }catch(e){
      showDetEr("Tag save failed: " + e.message);
    }
  };

  document.getElementById("copyPhone").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(currentId || "");
      showDetOk("Phone copied ✅");
    }catch{
      showDetEr("Copy failed.");
    }
  };
</script>

</body>
</html>
