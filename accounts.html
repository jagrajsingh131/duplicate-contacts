<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accounts | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=200">

  <!-- Excel support -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="adminShell">

  <!-- SIDEBAR -->
  <aside class="sideNav">
    <div class="sideTop">
      <div class="sideLogo">BM</div>
      <div>
        <div class="sideName">Buckup-Media</div>
        <div class="sideSub">Accounts</div>
      </div>
    </div>

    <nav class="sideMenu">
      <button class="navItem" id="goHome">Home</button>
      <button class="navItem active">Accounts</button>
      <button class="navItem" id="goTool">Data Duplicater</button>
      <button class="navItem" id="goWallet">Wallet</button>
      <button class="navItem" id="goAdmin">Admin</button>
    </nav>

    <div class="sideBottom">
      <div class="sideHint">Shared database</div>
      <div class="sideSmall">© Buckup-Media</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="mainArea">
    <header class="topBar">
      <div>
        <div class="topTitle">Accounts</div>
        <div class="topSub">Paste • Upload • Add • Tag • Filter • Details</div>
      </div>

      <div class="topRight">
        <span class="chip" id="verChip">Verified</span>
        <button class="toolBtn ghost" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <main class="content">
      <section class="page show">

        <!-- ACTIONS / FILTERS -->
        <div class="cardX" data-tilt>
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Accounts Manager</div>
              <div class="cardXSub">Add accounts in any format. We auto-clean names and phones.</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <button class="toolBtn primary" id="openAdd">Add More Accounts</button>
              <button class="toolBtn ghost" id="openUpload">Upload CSV/Excel</button>
              <button class="toolBtn ghost" id="downloadSample">Sample CSV</button>
              <span class="chip small" id="countChip">0</span>
            </div>
          </div>

          <!-- 1-by-1 add form -->
          <div class="bmOneByOne">
            <div class="bmLabel">Add single account</div>
            <div class="bmRow">
              <input class="toolInput" id="oneName" placeholder="Name (example: Shekhu Gupta)">
              <input class="toolInput" id="onePhone" placeholder="Phone (10 digits)">
              <button class="toolBtn primary" id="addOneBtn">Add</button>
            </div>
            <div class="bmSmallNote">Tip: we will auto-fix spaces in name and keep last 10 digits of phone.</div>
          </div>

          <!-- filters -->
          <div class="bmFilters">
            <div class="bmF">
              <div class="bmLabel">Tag</div>
              <select class="toolInput compact" id="filterTag">
                <option value="">All</option>
                <option value="locked">Locked</option>
                <option value="cod issue">COD Issue</option>
                <option value="incorrect password">Incorrect Password</option>
                <option value="ok">OK</option>
              </select>
            </div>

            <div class="bmF">
              <div class="bmLabel">Created by (email)</div>
              <input class="toolInput compact" id="filterBy" placeholder="example@gmail.com">
            </div>

            <div class="bmF">
              <div class="bmLabel">Created date</div>
              <input class="toolInput compact" id="filterDate" type="date">
            </div>

            <div class="bmF grow">
              <div class="bmLabel">Search</div>
              <input class="toolInput compact" id="searchBox" placeholder="search name / phone">
            </div>
          </div>

          <div id="er" class="toolMsg err"></div>
          <div id="ok" class="toolMsg ok"></div>
        </div>

        <!-- TABLE -->
        <div class="cardX" data-tilt style="margin-top:16px;">
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Accounts List</div>
              <div class="cardXSub">Click phone to open account details</div>
            </div>
          </div>

          <div class="accTableWrap" style="margin-top:12px;">
            <table class="accTable">
              <thead>
                <tr>
                  <th style="width:44%;">Name</th>
                  <th style="width:24%;">Phone</th>
                  <th style="width:14%;">Tag</th>
                  <th style="width:18%;">Actions</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr class="skRow"><td colspan="4">
                  <div class="skLine"></div>
                  <div class="skLine w80"></div>
                  <div class="skLine w60"></div>
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- ADD MODAL (paste) -->
  <div class="bmModalBack" id="addModal" style="display:none;">
    <div class="bmModalCard">
      <div class="bmModalTop">
        <div>
          <div class="bmModalTitle">Add Accounts</div>
          <div class="bmModalSub">Paste any format. Phone should be at end of line.</div>
        </div>
        <button class="toolBtn ghost" id="closeAdd" style="padding:10px 12px;">✕</button>
      </div>

      <textarea id="pasteBox" class="toolInput bmArea"
        placeholder="Shekhu Gupta	9731523112
Mohini Karana	9871519319
AR Raghavan - 7621809197"></textarea>

      <div class="bmSmallNote">
        We clean: name = single spaces only, phone = last 10 digits only.
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="toolBtn ghost" id="clearPaste">Clear</button>
        <button class="toolBtn primary" id="savePaste">Save</button>
      </div>

      <div id="addInfo" class="toolMsg"></div>
    </div>
  </div>

  <!-- UPLOAD MODAL -->
  <div class="bmModalBack" id="uploadModal" style="display:none;">
    <div class="bmModalCard">
      <div class="bmModalTop">
        <div>
          <div class="bmModalTitle">Upload CSV / Excel</div>
          <div class="bmModalSub">CSV columns: name, phone | Excel: first sheet (Name/Phone)</div>
        </div>
        <button class="toolBtn ghost" id="closeUpload" style="padding:10px 12px;">✕</button>
      </div>

      <input id="fileInput" type="file" class="toolInput" accept=".csv,.xlsx,.xls" />

      <div class="bmSmallNote">
        CSV example headers: <b>name,phone</b> (or <b>Name,Phone</b>)<br/>
        Excel: first two columns can be Name and Phone.
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="toolBtn ghost" id="clearFile">Clear</button>
        <button class="toolBtn primary" id="uploadSave">Upload & Save</button>
      </div>

      <div id="uploadInfo" class="toolMsg"></div>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="bmModalBack" id="detailModal" style="display:none;">
    <div class="bmModalCard">
      <div class="bmModalTop">
        <div>
          <div class="bmModalTitle">Account Details</div>
          <div class="bmModalSub">Created by/time shown only here</div>
        </div>
        <button class="toolBtn ghost" id="closeDetail" style="padding:10px 12px;">✕</button>
      </div>

      <div class="bmDetailGrid">
        <div class="bmDetailItem">
          <div class="bmK">Name</div>
          <div class="bmV" id="dName">—</div>
        </div>
        <div class="bmDetailItem">
          <div class="bmK">Phone</div>
          <div class="bmV mono" id="dPhone">—</div>
        </div>
        <div class="bmDetailItem">
          <div class="bmK">Tag</div>
          <div class="bmV" id="dTag">—</div>
        </div>
        <div class="bmDetailItem">
          <div class="bmK">Created By</div>
          <div class="bmV" id="dBy">—</div>
        </div>
        <div class="bmDetailItem">
          <div class="bmK">Created At</div>
          <div class="bmV" id="dAt">—</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="bmLabel">Update tag</div>
        <select class="toolInput" id="tagSelect">
          <option value="">No tag</option>
          <option value="locked">Locked</option>
          <option value="cod issue">COD Issue</option>
          <option value="incorrect password">Incorrect Password</option>
          <option value="ok">OK</option>
        </select>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="toolBtn ghost" id="copyDetail">Copy Name + Phone</button>
        <button class="toolBtn primary" id="saveTag">Save Tag</button>
      </div>

      <div id="detailInfo" class="toolMsg"></div>
    </div>
  </div>

<script type="module">
  import { auth } from "./firebase.js";
  import { getSession } from "./cache.js";
  import { API_BASE } from "./config.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // Session check
  const sess = getSession();
  if (!sess) location.href = "index.html";

  // Require login + email verified
  onAuthStateChanged(auth, (u)=>{
    if (!u) location.href = "index.html";
    if (!u.emailVerified) location.href = "index.html";
  });

  // NAV
  document.getElementById("goHome").onclick = ()=> location.href="home.html";
  document.getElementById("goTool").onclick = ()=> location.href="dashboard.html";
  document.getElementById("goWallet").onclick = ()=> location.href="wallet.html";
  document.getElementById("goAdmin").onclick = ()=> location.href="admin.html";
  document.getElementById("refreshBtn").onclick = ()=> location.reload();

  // Tilt
  (function initTilt(){
    const cards = document.querySelectorAll("[data-tilt]");
    cards.forEach(card=>{
      card.addEventListener("mousemove", (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width - 0.5;
        const y = (e.clientY - r.top) / r.height - 0.5;
        card.style.transform = `perspective(900px) rotateX(${(-y*2.6).toFixed(2)}deg) rotateY(${(x*2.6).toFixed(2)}deg) translateY(-2px)`;
      });
      card.addEventListener("mouseleave", ()=>{
        card.style.transform = `perspective(900px) rotateX(0deg) rotateY(0deg) translateY(0px)`;
      });
    });
  })();

  // UI refs
  const rows = document.getElementById("rows");
  const er = document.getElementById("er");
  const ok = document.getElementById("ok");
  const countChip = document.getElementById("countChip");
  const filterTag = document.getElementById("filterTag");
  const filterBy = document.getElementById("filterBy");
  const filterDate = document.getElementById("filterDate");
  const searchBox = document.getElementById("searchBox");

  const oneName = document.getElementById("oneName");
  const onePhone = document.getElementById("onePhone");
  const addOneBtn = document.getElementById("addOneBtn");

  // modals
  const addModal = document.getElementById("addModal");
  const openAdd = document.getElementById("openAdd");
  const closeAdd = document.getElementById("closeAdd");
  const pasteBox = document.getElementById("pasteBox");
  const clearPaste = document.getElementById("clearPaste");
  const savePaste = document.getElementById("savePaste");
  const addInfo = document.getElementById("addInfo");

  const uploadModal = document.getElementById("uploadModal");
  const openUpload = document.getElementById("openUpload");
  const closeUpload = document.getElementById("closeUpload");
  const fileInput = document.getElementById("fileInput");
  const clearFile = document.getElementById("clearFile");
  const uploadSave = document.getElementById("uploadSave");
  const uploadInfo = document.getElementById("uploadInfo");

  const detailModal = document.getElementById("detailModal");
  const closeDetail = document.getElementById("closeDetail");
  const dName = document.getElementById("dName");
  const dPhone = document.getElementById("dPhone");
  const dTag = document.getElementById("dTag");
  const dBy = document.getElementById("dBy");
  const dAt = document.getElementById("dAt");
  const tagSelect = document.getElementById("tagSelect");
  const saveTag = document.getElementById("saveTag");
  const copyDetail = document.getElementById("copyDetail");
  const detailInfo = document.getElementById("detailInfo");

  // sample download
  const downloadSample = document.getElementById("downloadSample");

  let allAccounts = [];
  let selectedId = null;

  function showErr(t){ er.style.display="block"; er.textContent=t; }
  function clearErr(){ er.style.display="none"; er.textContent=""; }
  function showOk(t){ ok.style.display="block"; ok.textContent=t; setTimeout(()=>{ ok.style.display="none"; }, 2400); }

  function toast(el, msg, kind="ok"){
    el.style.display="block";
    el.className = "toolMsg " + (kind==="err" ? "err" : "ok");
    el.textContent = msg;
    setTimeout(()=>{ el.style.display="none"; }, 2600);
  }

  function fmtTime(ts){
    try{
      if (!ts) return "—";
      const d = (typeof ts === "string") ? new Date(ts) : new Date(ts);
      return d.toLocaleString();
    }catch{ return "—"; }
  }

  function copyText(t){ navigator.clipboard.writeText(t).catch(()=>{}); }

  // ===== AUTH + API =====
  async function getIdToken() {
    const u = auth.currentUser;
    if (!u) throw new Error("Not logged in");
    return await u.getIdToken(true);
  }

  async function apiFetch(path, options = {}) {
    const token = await getIdToken();
    const res = await fetch(API_BASE + path, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token,
        ...(options.headers || {})
      }
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || "API Error");
    return data;
  }

  // ===== CLEANERS (strong) =====
  function normalizeLine(line){
    return (line || "")
      .replace(/[\u00A0\u2000-\u200B\u202F\u205F\u3000]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }
  function cleanName(raw){
    return normalizeLine(raw);
  }
  function cleanPhone(raw){
    const digits = (raw || "").replace(/\D/g, "");
    if (digits.length >= 10) return digits.slice(-10);
    return "";
  }

  // Parse paste lines: phone must be at END
  function parseAccounts(text){
    const out = [];
    const lines = (text || "").split(/\r?\n/);

    for (let line of lines){
      if (!line) continue;
      const fixed = (line || "").replace(/[\u00A0\u2000-\u200B\u202F\u205F\u3000]/g, " ").trim();
      if (!fixed) continue;

      // phone-like at end
      const m = fixed.match(/(\+?\d[\d\s\-\(\)]{7,}\d)\s*$/);
      if (!m) continue;

      const phone = cleanPhone(m[1]);
      if (!phone) continue;

      let namePart = fixed.slice(0, fixed.length - m[0].length);
      namePart = namePart.replace(/[\t ,;|:\-]+$/g, "");
      const name = cleanName(namePart);
      if (!name) continue;

      out.push({ name, phone });
    }

    const seen = new Set();
    return out.filter(a=>{
      if (seen.has(a.phone)) return false;
      seen.add(a.phone);
      return true;
    });
  }

  // ===== TABLE render =====
  function setSkeleton(){
    rows.innerHTML = `
      <tr class="skRow"><td colspan="4">
        <div class="skLine"></div>
        <div class="skLine w80"></div>
        <div class="skLine w60"></div>
      </td></tr>`;
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    clearErr();

    countChip.textContent = allAccounts.length.toLocaleString("en-IN");

    if (!allAccounts.length){
      rows.innerHTML = `<tr><td colspan="4" style="padding:14px;color:#9fb1d3;">No accounts found.</td></tr>`;
      return;
    }

    rows.innerHTML = allAccounts.map(a=>{
      const tag = a.tag ? a.tag : "";
      const tagPill = tag
        ? `<span class="bmTag">${escapeHtml(tag)}</span>`
        : `<span class="bmTag soft">—</span>`;

      return `
        <tr>
          <td>
            <div class="bmRowFlex">
              <span style="font-weight:1000;">${escapeHtml(a.name || "")}</span>
              <button class="bmMiniBtn" data-copy="${encodeURIComponent(a.name || "")}">Copy</button>
            </div>
          </td>

          <td class="mono">
            <div class="bmRowFlex">
              <button class="bmLink" data-open="${a.id}">${escapeHtml(a.phone || "")}</button>
              <button class="bmMiniBtn" data-copy="${encodeURIComponent(a.phone || "")}">Copy</button>
            </div>
          </td>

          <td>${tagPill}</td>

          <td>
            <select class="toolInput compact" data-tag="${a.id}">
              <option value="" ${!tag?"selected":""}>No tag</option>
              <option value="locked" ${tag==="locked"?"selected":""}>Locked</option>
              <option value="cod issue" ${tag==="cod issue"?"selected":""}>COD Issue</option>
              <option value="incorrect password" ${tag==="incorrect password"?"selected":""}>Incorrect Password</option>
              <option value="ok" ${tag==="ok"?"selected":""}>OK</option>
            </select>
          </td>
        </tr>
      `;
    }).join("");

    rows.querySelectorAll("[data-copy]").forEach(b=>{
      b.onclick = ()=> copyText(decodeURIComponent(b.dataset.copy || ""));
    });

    rows.querySelectorAll("[data-open]").forEach(b=>{
      b.onclick = ()=> openDetails(b.dataset.open);
    });

    rows.querySelectorAll("[data-tag]").forEach(sel=>{
      sel.onchange = async ()=>{
        try{
          await apiFetch(`/accounts/${sel.dataset.tag}/tag`, {
            method: "PATCH",
            body: JSON.stringify({ tag: sel.value || "" })
          });
          await loadAccounts();
        }catch(e){
          showErr(e.message);
        }
      };
    });
  }

  // ===== DETAILS =====
  function openDetails(id){
    const a = allAccounts.find(x=>String(x.id)===String(id));
    if (!a) return;
    selectedId = String(id);

    dName.textContent = a.name || "—";
    dPhone.textContent = a.phone || "—";
    dTag.textContent = a.tag || "—";
    dBy.textContent = a.createdBy || "—";
    dAt.textContent = fmtTime(a.createdAt);
    tagSelect.value = a.tag || "";

    detailModal.style.display = "flex";
  }

  closeDetail.onclick = ()=> detailModal.style.display="none";
  detailModal.addEventListener("click",(e)=>{
    if (e.target === detailModal) detailModal.style.display="none";
  });

  copyDetail.onclick = ()=>{
    const a = allAccounts.find(x=>String(x.id)===String(selectedId));
    if (!a) return;
    copyText(`${a.name}\t${a.phone}`);
    toast(detailInfo, "Copied (Name + Phone)", "ok");
  };

  saveTag.onclick = async ()=>{
    if (!selectedId) return;
    try{
      await apiFetch(`/accounts/${selectedId}/tag`, {
        method: "PATCH",
        body: JSON.stringify({ tag: tagSelect.value || "" })
      });
      toast(detailInfo, "Tag updated", "ok");
      await loadAccounts();
    }catch(e){
      toast(detailInfo, e.message, "err");
    }
  };

  // ===== LOAD from SQL =====
  async function loadAccounts(){
    try{
      clearErr();
      setSkeleton();

      const tag = (filterTag.value || "").trim();
      const createdBy = (filterBy.value || "").trim();
      const date = (filterDate.value || "").trim();
      const q = (searchBox.value || "").trim();

      const qs = new URLSearchParams();
      if (tag) qs.set("tag", tag);
      if (createdBy) qs.set("createdBy", createdBy);
      if (date) qs.set("date", date);
      if (q) qs.set("q", q);

      const data = await apiFetch("/accounts?" + qs.toString(), { method: "GET" });

      allAccounts = (data.accounts || []).map(a => ({
        id: String(a.id),
        name: a.name,
        phone: a.phone,
        tag: (a.tag || "").toLowerCase(),
        createdBy: a.created_by_email || "",
        createdAt: a.created_at
      }));

      render();
    }catch(e){
      showErr("Cannot load accounts: " + e.message);
      rows.innerHTML = `<tr><td colspan="4" style="padding:14px;color:#ffb4b4;">Failed to load accounts.</td></tr>`;
    }
  }

  // filter events -> reload from server
  filterTag.onchange = loadAccounts;
  filterBy.oninput = debounce(loadAccounts, 400);
  filterDate.onchange = loadAccounts;
  searchBox.oninput = debounce(loadAccounts, 350);

  function debounce(fn, ms){
    let t = null;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=> fn(...args), ms);
    };
  }

  // ===== ADD MODAL (paste) =====
  openAdd.onclick = ()=>{ addModal.style.display="flex"; pasteBox.focus(); };
  closeAdd.onclick = ()=> addModal.style.display="none";
  addModal.addEventListener("click",(e)=>{
    if (e.target === addModal) addModal.style.display="none";
  });
  clearPaste.onclick = ()=> pasteBox.value="";

  savePaste.onclick = async ()=>{
    try{
      addInfo.style.display="none";
      const raw = pasteBox.value || "";
      const parsed = parseAccounts(raw);

      const totalLines = raw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean).length;
      const skipped = Math.max(0, totalLines - parsed.length);

      if (!parsed.length){
        toast(addInfo, "No valid accounts found. Phone must be at end of each line.", "err");
        return;
      }

      await apiFetch("/accounts/bulk", {
        method: "POST",
        body: JSON.stringify({ accounts: parsed })
      });

      toast(addInfo, `Saved ${parsed.length}. Skipped ${skipped}.`, "ok");
      pasteBox.value = "";
      await loadAccounts();
    }catch(e){
      toast(addInfo, e.message, "err");
    }
  };

  // ===== ONE-BY-ONE ADD =====
  addOneBtn.onclick = async ()=>{
    try{
      clearErr();
      const name = cleanName(oneName.value);
      const phone = cleanPhone(onePhone.value);
      if (!name || !phone){
        showErr("Enter valid Name and 10-digit Phone.");
        return;
      }

      await apiFetch("/accounts", {
        method: "POST",
        body: JSON.stringify({ name, phone })
      });

      oneName.value = "";
      onePhone.value = "";
      showOk("Account added");
      await loadAccounts();
    }catch(e){
      showErr(e.message);
    }
  };

  // ===== UPLOAD MODAL =====
  openUpload.onclick = ()=>{ uploadModal.style.display="flex"; };
  closeUpload.onclick = ()=> uploadModal.style.display="none";
  uploadModal.addEventListener("click",(e)=>{
    if (e.target === uploadModal) uploadModal.style.display="none";
  });
  clearFile.onclick = ()=> fileInput.value = "";

  function parseCSV(text){
    // minimal CSV parser: expects columns (name, phone) in any case
    const lines = (text || "").split(/\r?\n/).filter(Boolean);
    if (!lines.length) return [];
    const header = lines[0].split(",").map(h=>normalizeLine(h).toLowerCase());
    const nameIdx = header.findIndex(h=>h==="name");
    const phoneIdx = header.findIndex(h=>h==="phone" || h==="number" || h==="mobile");
    if (nameIdx === -1 || phoneIdx === -1) return [];

    const out = [];
    for (let i=1;i<lines.length;i++){
      const parts = lines[i].split(",");
      const name = cleanName(parts[nameIdx] || "");
      const phone = cleanPhone(parts[phoneIdx] || "");
      if (name && phone) out.push({ name, phone });
    }
    // dedupe by phone
    const seen = new Set();
    return out.filter(a=>{ if(seen.has(a.phone)) return false; seen.add(a.phone); return true; });
  }

  async function readFileAsText(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsText(file);
    });
  }

  async function parseExcel(file){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

    // expect first row header or direct data
    // try detect headers
    let start = 0;
    if (rows.length){
      const first = (rows[0] || []).map(x=>normalizeLine(String(x||"")).toLowerCase());
      const hasHeader = first.includes("name") && (first.includes("phone") || first.includes("number") || first.includes("mobile"));
      if (hasHeader) start = 1;
    }

    const out = [];
    for (let i=start;i<rows.length;i++){
      const r = rows[i] || [];
      const n = cleanName(r[0] || "");
      const p = cleanPhone(r[1] || "");
      if (n && p) out.push({ name:n, phone:p });
    }

    const seen = new Set();
    return out.filter(a=>{ if(seen.has(a.phone)) return false; seen.add(a.phone); return true; });
  }

  uploadSave.onclick = async ()=>{
    try{
      uploadInfo.style.display = "none";
      const file = fileInput.files && fileInput.files[0];
      if (!file){
        toast(uploadInfo, "Select CSV or Excel file first.", "err");
        return;
      }

      let accounts = [];

      if (file.name.toLowerCase().endsWith(".csv")){
        const txt = await readFileAsText(file);
        accounts = parseCSV(txt);
      } else if (file.name.toLowerCase().endsWith(".xlsx") || file.name.toLowerCase().endsWith(".xls")){
        accounts = await parseExcel(file);
      } else {
        toast(uploadInfo, "Only CSV / Excel supported.", "err");
        return;
      }

      if (!accounts.length){
        toast(uploadInfo, "No valid rows found. Use sample CSV format: name,phone", "err");
        return;
      }

      await apiFetch("/accounts/bulk", {
        method: "POST",
        body: JSON.stringify({ accounts })
      });

      toast(uploadInfo, `Uploaded & saved ${accounts.length} accounts.`, "ok");
      fileInput.value = "";
      await loadAccounts();
    }catch(e){
      toast(uploadInfo, e.message, "err");
    }
  };

  // ===== SAMPLE CSV DOWNLOAD =====
  downloadSample.onclick = ()=>{
    const sample =
`name,phone
Shekhu Gupta,9731523112
Mohini Karana,9871519319
AR Raghavan,7621809197
`;
    const blob = new Blob([sample], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "accounts_sample.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  // close modals ESC
  document.addEventListener("keydown",(e)=>{
    if (e.key === "Escape"){
      addModal.style.display = "none";
      uploadModal.style.display = "none";
      detailModal.style.display = "none";
    }
  });

  // first load
  loadAccounts();

</script>

<style>
  /* Minimal page-specific CSS (keeps your theme) */
  .bmFilters{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
  .bmF{ min-width:200px; }
  .bmF.grow{ flex:1; min-width:240px; }

  .bmOneByOne{ margin-top:14px; }
  .bmRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .bmRow .toolInput{ flex:1; min-width:220px; }

  .bmModalBack{
    position:fixed; inset:0; z-index:90;
    background:rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center;
    padding:16px;
  }
  .bmModalCard{
    width:min(820px,100%);
    border-radius:24px;
    padding:14px;
    border:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(700px 260px at 15% 0%, rgba(109,94,252,.22), transparent 60%),
      radial-gradient(650px 280px at 92% 18%, rgba(56,212,166,.16), transparent 60%),
      rgba(255,255,255,.05);
    box-shadow: 0 25px 70px rgba(0,0,0,.55);
    backdrop-filter: blur(10px);
  }
  .bmModalTop{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; margin-bottom:10px; }
  .bmModalTitle{ font-weight:1100; font-size:18px; }
  .bmModalSub{ font-weight:800; font-size:12px; color:#9fb1d3; margin-top:3px; }
  .bmArea{ height:240px; resize:vertical; }
  .bmSmallNote{ margin-top:10px; color:#9fb1d3; font-weight:800; font-size:12px; }

  .bmRowFlex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .bmMiniBtn{
    padding:6px 10px; border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:#e7eefc; font-weight:900;
    cursor:pointer;
  }
  .bmMiniBtn:hover{ background:rgba(255,255,255,.08); }
  .bmLink{
    background:transparent; border:none; cursor:pointer;
    color:#9ad7ff; font-weight:1000;
    text-decoration:underline;
  }
  .bmTag{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    font-weight:1000;
    font-size:12px;
    border:1px solid rgba(109,94,252,.50);
    background:linear-gradient(90deg,rgba(109,94,252,.30),rgba(56,212,166,.18));
  }
  .bmTag.soft{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.05);
  }
  .bmDetailGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  .bmDetailItem{
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
  }
  .bmK{ color:#9fb1d3; font-weight:900; font-size:12px; }
  .bmV{ margin-top:6px; font-weight:1000; }
</style>

</body>
</html>
