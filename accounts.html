<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accounts | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=120">
</head>

<body class="adminShell">

  <!-- SIDEBAR -->
  <aside class="sideNav">
    <div class="sideTop">
      <div class="sideLogo">BM</div>
      <div>
        <div class="sideName">Buckup-Media</div>
        <div class="sideSub">Accounts</div>
      </div>
    </div>

    <nav class="sideMenu">
      <button class="navItem" id="goHome">Home</button>
      <button class="navItem active">Accounts</button>
      <button class="navItem" id="goTool">Data Duplicater</button>
      <button class="navItem" id="goWallet">Wallet</button>
      <button class="navItem" id="goAdmin">Admin</button>
    </nav>

    <div class="sideBottom">
      <div class="sideHint">Shared database</div>
      <div class="sideSmall">© Buckup-Media</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="mainArea">
    <header class="topBar">
      <div>
        <div class="topTitle">Accounts</div>
        <div class="topSub">Shared list • Tags • Filters • Details</div>
      </div>

      <div class="topRight">
        <span class="chip" id="verChip">Verified</span>
        <button class="toolBtn ghost" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <main class="content">
      <section class="page show">

        <!-- TOP CONTROLS -->
        <div class="cardX hoverParallax" data-tilt>
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Add more accounts</div>
              <div class="cardXSub">Paste in any format. We auto-clean it.</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <button class="toolBtn primary" id="openAdd">Add More Accounts</button>
            </div>
          </div>

          <div class="filterRow" style="margin-top:14px;">
            <div class="filterBox">
              <div class="filterLabel">Filter by tag</div>
              <select class="toolInput compact" id="filterTag">
                <option value="">All</option>
                <option value="locked">Locked</option>
                <option value="cod issue">COD Issue</option>
                <option value="incorrect password">Incorrect Password</option>
                <option value="ok">OK</option>
              </select>
            </div>

            <div class="filterBox">
              <div class="filterLabel">Created by (email)</div>
              <input class="toolInput compact" id="filterBy" placeholder="example@gmail.com">
            </div>

            <div class="filterBox">
              <div class="filterLabel">Created date (YYYY-MM-DD)</div>
              <input class="toolInput compact" id="filterDate" type="date">
            </div>

            <div class="filterBox grow">
              <div class="filterLabel">Search name / phone</div>
              <input class="toolInput compact" id="searchBox" placeholder="type to search...">
            </div>
          </div>
        </div>

        <!-- TABLE -->
        <div class="cardX hoverParallax" data-tilt style="margin-top:16px;">
          <div class="cardXTop">
            <div>
              <div class="cardXTitle">Accounts List</div>
              <div class="cardXSub">Click phone to open details</div>
            </div>
            <div class="chip small" id="countChip">0</div>
          </div>

          <div id="er" class="toolMsg err"></div>

          <div class="accTableWrap" style="margin-top:12px;">
            <table class="accTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Tag</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr class="skRow"><td colspan="4">
                  <div class="skLine"></div>
                  <div class="skLine w80"></div>
                  <div class="skLine w60"></div>
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- ADD MODAL -->
  <div class="modalBack" id="addModal" style="display:none;">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <div class="modalTitle">Paste Accounts</div>
          <div class="modalSub">We accept any separators. Phone must be last in line.</div>
        </div>
        <button class="xBtn" id="closeAdd">✕</button>
      </div>

      <textarea id="pasteBox" class="toolInput" style="height:220px;resize:vertical;"
        placeholder="Example:
Dhananjay   Butala     9884155629
Kajal Shenoy - 84 38 52 51 92
Anaya Deshpande,7354177191
Name<TAB>Phone"></textarea>

      <div class="modalHint">
        ✅ Name will be cleaned to single spaces. ✅ Phone keeps last 10 digits.
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="toolBtn ghost" id="clearPaste">Clear</button>
        <button class="toolBtn primary" id="savePaste">Save Accounts</button>
      </div>

      <div class="toolMsg" id="addInfo" style="display:none;"></div>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modalBack" id="detailModal" style="display:none;">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <div class="modalTitle">Account Details</div>
          <div class="modalSub">Full info + tag update</div>
        </div>
        <button class="xBtn" id="closeDetail">✕</button>
      </div>

      <div class="detailGrid">
        <div class="detailItem">
          <div class="detailK">Name</div>
          <div class="detailV" id="dName">—</div>
        </div>
        <div class="detailItem">
          <div class="detailK">Phone</div>
          <div class="detailV mono" id="dPhone">—</div>
        </div>
        <div class="detailItem">
          <div class="detailK">Tag</div>
          <div class="detailV" id="dTag">—</div>
        </div>
        <div class="detailItem">
          <div class="detailK">Created By</div>
          <div class="detailV" id="dBy">—</div>
        </div>
        <div class="detailItem">
          <div class="detailK">Created At</div>
          <div class="detailV" id="dAt">—</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="filterLabel">Change tag</div>
        <select class="toolInput" id="tagSelect">
          <option value="">No tag</option>
          <option value="locked">Locked</option>
          <option value="cod issue">COD Issue</option>
          <option value="incorrect password">Incorrect Password</option>
          <option value="ok">OK</option>
        </select>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="toolBtn ghost" id="copyDetail">Copy (Name + Phone)</button>
        <button class="toolBtn primary" id="saveTag">Save Tag</button>
      </div>

      <div class="toolMsg" id="detailInfo" style="display:none;"></div>
    </div>
  </div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getSession } from "./cache.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // require login
  const sess = getSession();
  if (!sess) location.href = "index.html";

  onAuthStateChanged(auth, (u)=>{
    if (!u) location.href = "index.html";
    if (!u.emailVerified) location.href = "index.html";
  });

  // nav
  document.getElementById("goHome").onclick = ()=> location.href="home.html";
  document.getElementById("goTool").onclick = ()=> location.href="dashboard.html";
  document.getElementById("goWallet").onclick = ()=> location.href="wallet.html";
  document.getElementById("goAdmin").onclick = ()=> location.href="admin.html";
  document.getElementById("refreshBtn").onclick = ()=> location.reload();

  // tilt
  (function initTilt(){
    const cards = document.querySelectorAll("[data-tilt]");
    cards.forEach(card=>{
      card.addEventListener("mousemove", (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width - 0.5;
        const y = (e.clientY - r.top) / r.height - 0.5;
        card.style.transform = `perspective(900px) rotateX(${(-y*3).toFixed(2)}deg) rotateY(${(x*3).toFixed(2)}deg) translateY(-2px)`;
      });
      card.addEventListener("mouseleave", ()=>{
        card.style.transform = `perspective(900px) rotateX(0deg) rotateY(0deg) translateY(0px)`;
      });
    });
  })();

  // UI refs
  const rows = document.getElementById("rows");
  const er = document.getElementById("er");
  const countChip = document.getElementById("countChip");

  const filterTag = document.getElementById("filterTag");
  const filterBy = document.getElementById("filterBy");
  const filterDate = document.getElementById("filterDate");
  const searchBox = document.getElementById("searchBox");

  // add modal
  const addModal = document.getElementById("addModal");
  const openAdd = document.getElementById("openAdd");
  const closeAdd = document.getElementById("closeAdd");
  const pasteBox = document.getElementById("pasteBox");
  const clearPaste = document.getElementById("clearPaste");
  const savePaste = document.getElementById("savePaste");
  const addInfo = document.getElementById("addInfo");

  // detail modal
  const detailModal = document.getElementById("detailModal");
  const closeDetail = document.getElementById("closeDetail");
  const dName = document.getElementById("dName");
  const dPhone = document.getElementById("dPhone");
  const dTag = document.getElementById("dTag");
  const dBy = document.getElementById("dBy");
  const dAt = document.getElementById("dAt");
  const tagSelect = document.getElementById("tagSelect");
  const saveTag = document.getElementById("saveTag");
  const copyDetail = document.getElementById("copyDetail");
  const detailInfo = document.getElementById("detailInfo");

  let allAccounts = [];
  let selectedId = null;

  function showErr(t){
    er.style.display="block"; er.textContent=t;
  }
  function clearErr(){
    er.style.display="none"; er.textContent="";
  }
  function info(el, msg, kind="ok"){
    el.style.display="block";
    el.className = "toolMsg " + (kind==="err" ? "err" : "ok");
    el.textContent = msg;
    setTimeout(()=>{ el.style.display="none"; }, 2800);
  }

  function fmtTime(ts){
    try{
      if (!ts) return "—";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }catch{ return "—"; }
  }

  // ===== Parsing: accept ANY format =====
  function cleanName(raw){
    return (raw || "").replace(/\s+/g, " ").trim();
  }
  function cleanPhone(raw){
    const digits = (raw || "").replace(/\D/g, "");
    if (digits.length >= 10) return digits.slice(-10);
    return "";
  }

  function parseAccounts(text){
    const out = [];
    const lines = (text || "").split(/\r?\n/);

    for (let line of lines){
      line = line.trim();
      if (!line) continue;

      // find last phone-like run at end of line
      const phoneMatch = line.match(/(\+?\d[\d\s\-()]{7,}\d)\s*$/);
      if (!phoneMatch) continue;

      const phone = cleanPhone(phoneMatch[1]);
      if (!phone) continue;

      let nameRaw = line.slice(0, line.length - phoneMatch[0].length);
      nameRaw = nameRaw.replace(/[\t,;|:-]+$/g, "");
      const name = cleanName(nameRaw);
      if (!name) continue;

      out.push({ name, phone });
    }

    // dedupe within paste by phone
    const seen = new Set();
    return out.filter(a=>{
      if (seen.has(a.phone)) return false;
      seen.add(a.phone);
      return true;
    });
  }

  // ===== Filters =====
  function passesFilters(a){
    const tg = (filterTag.value || "").trim().toLowerCase();
    const by = (filterBy.value || "").trim().toLowerCase();
    const dt = (filterDate.value || "").trim();
    const q = (searchBox.value || "").trim().toLowerCase();

    if (tg && (String(a.tag||"").toLowerCase() !== tg)) return false;
    if (by && !(String(a.createdBy||"").toLowerCase().includes(by))) return false;

    if (dt){
      const d = a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt ? new Date(a.createdAt) : null);
      if (!d) return false;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const stamp = `${yyyy}-${mm}-${dd}`;
      if (stamp !== dt) return false;
    }

    if (q){
      const n = String(a.name||"").toLowerCase();
      const p = String(a.phone||"").toLowerCase();
      if (!n.includes(q) && !p.includes(q)) return false;
    }

    return true;
  }

  function copyText(text){
    navigator.clipboard.writeText(text).catch(()=>{});
  }

  function render(){
    clearErr();

    const list = allAccounts.filter(passesFilters);
    countChip.textContent = list.length.toLocaleString("en-IN");

    if (!list.length){
      rows.innerHTML = `<tr><td colspan="4" style="padding:14px;color:#64748b;">No accounts found.</td></tr>`;
      return;
    }

    rows.innerHTML = list.map(a=>{
      const tag = a.tag ? a.tag : "";
      return `
        <tr>
          <td>
            <div class="rowFlex">
              <span class="strong">${a.name}</span>
              <button class="miniCopy" data-copy="${encodeURIComponent(a.name)}" title="Copy name">Copy</button>
            </div>
          </td>

          <td class="mono">
            <div class="rowFlex">
              <button class="linkBtn" data-open="${a.id}" title="Open details">${a.phone}</button>
              <button class="miniCopy" data-copy="${encodeURIComponent(a.phone)}" title="Copy phone">Copy</button>
            </div>
          </td>

          <td>
            ${tag ? `<span class="tagPill">${tag}</span>` : `<span class="tagPill soft">—</span>`}
          </td>

          <td>
            <select class="toolInput compact" data-tag="${a.id}">
              <option value="" ${!tag?"selected":""}>No tag</option>
              <option value="locked" ${tag==="locked"?"selected":""}>Locked</option>
              <option value="cod issue" ${tag==="cod issue"?"selected":""}>COD Issue</option>
              <option value="incorrect password" ${tag==="incorrect password"?"selected":""}>Incorrect Password</option>
              <option value="ok" ${tag==="ok"?"selected":""}>OK</option>
            </select>
          </td>
        </tr>
      `;
    }).join("");

    // copy buttons
    rows.querySelectorAll(".miniCopy").forEach(b=>{
      b.onclick = ()=> copyText(decodeURIComponent(b.dataset.copy));
    });

    // open details
    rows.querySelectorAll("[data-open]").forEach(b=>{
      b.onclick = ()=> openDetails(b.dataset.open);
    });

    // tag dropdown quick set
    rows.querySelectorAll("[data-tag]").forEach(sel=>{
      sel.onchange = async ()=>{
        try{
          await updateDoc(doc(db,"accounts", sel.dataset.tag), {
            tag: sel.value || ""
          });
        }catch(e){
          showErr(e.message);
        }
      };
    });
  }

  // ===== Details modal =====
  function openDetails(id){
    const a = allAccounts.find(x=>x.id===id);
    if (!a) return;

    selectedId = id;
    dName.textContent = a.name || "—";
    dPhone.textContent = a.phone || "—";
    dTag.textContent = a.tag || "—";
    dBy.textContent = a.createdBy || "—";
    dAt.textContent = fmtTime(a.createdAt);
    tagSelect.value = a.tag || "";

    detailModal.style.display="flex";
  }

  closeDetail.onclick = ()=> detailModal.style.display="none";
  detailModal.addEventListener("click", (e)=>{
    if (e.target === detailModal) detailModal.style.display="none";
  });

  copyDetail.onclick = ()=>{
    const a = allAccounts.find(x=>x.id===selectedId);
    if (!a) return;
    copyText(`${a.name}\t${a.phone}`);
    info(detailInfo, "Copied (Name + Phone)", "ok");
  };

  saveTag.onclick = async ()=>{
    if (!selectedId) return;
    try{
      await updateDoc(doc(db,"accounts",selectedId), {
        tag: tagSelect.value || ""
      });
      info(detailInfo, "Tag updated", "ok");
    }catch(e){
      info(detailInfo, e.message, "err");
    }
  };

  // ===== Add modal =====
  openAdd.onclick = ()=> { addModal.style.display="flex"; pasteBox.focus(); };
  closeAdd.onclick = ()=> addModal.style.display="none";
  addModal.addEventListener("click",(e)=>{
    if (e.target === addModal) addModal.style.display="none";
  });

  clearPaste.onclick = ()=> pasteBox.value="";

  savePaste.onclick = async ()=>{
    try{
      addInfo.style.display="none";

      const raw = pasteBox.value || "";
      const parsed = parseAccounts(raw);

      const totalLines = raw.split(/\r?\n/).filter(l=>l.trim()).length;
      const skipped = Math.max(0, totalLines - parsed.length);

      if (!parsed.length){
        info(addInfo, "No valid accounts found. Put phone at end of line.", "err");
        return;
      }

      // save each account
      let saved = 0;

      for (const a of parsed){
        await addDoc(collection(db,"accounts"), {
          name: a.name,
          phone: a.phone,
          tag: "",
          createdAt: serverTimestamp(),
          createdBy: sess.email || "",
          createdByUid: sess.uid || ""
        });
        saved++;
      }

      info(addInfo, `Saved ${saved} accounts. Skipped ${skipped} lines.`, "ok");
      pasteBox.value = "";
      // keep modal open for fast paste
    }catch(e){
      info(addInfo, e.message, "err");
    }
  };

  // filters re-render
  filterTag.onchange = render;
  filterBy.oninput = render;
  filterDate.onchange = render;
  searchBox.oninput = render;

  // ===== Load accounts shared =====
  function setSkeleton(){
    rows.innerHTML = `
      <tr class="skRow"><td colspan="4">
        <div class="skLine"></div>
        <div class="skLine w80"></div>
        <div class="skLine w60"></div>
      </td></tr>`;
  }

  setSkeleton();

  const qy = query(collection(db,"accounts"), orderBy("createdAt","desc"));
  onSnapshot(qy, (snap)=>{
    allAccounts = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    render();
  }, (e)=>{
    showErr("Cannot load accounts: " + e.message);
  });

</script>

<!-- Small page-specific CSS (keeps your theme intact) -->
<style>
  .filterRow{display:flex;gap:12px;flex-wrap:wrap}
  .filterBox{min-width:200px}
  .filterBox.grow{flex:1}
  .filterLabel{font-weight:900;font-size:12px;color:#9fb1d3;margin-bottom:6px}
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:16px;z-index:80}
  .modalCard{width:min(820px,100%);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:22px;padding:14px;box-shadow:0 25px 70px rgba(0,0,0,.55);backdrop-filter: blur(10px)}
  .modalTop{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px}
  .modalTitle{font-weight:1100;font-size:18px}
  .modalSub{font-weight:800;font-size:12px;color:#9fb1d3;margin-top:3px}
  .xBtn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);color:#e7eefc;border-radius:12px;padding:8px 10px;cursor:pointer}
  .modalHint{margin-top:8px;color:#9fb1d3;font-weight:800;font-size:12px}
  .rowFlex{display:flex;gap:10px;align-items:center}
  .strong{font-weight:1000}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .miniCopy{padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#e7eefc;font-weight:900;cursor:pointer}
  .miniCopy:hover{background:rgba(255,255,255,.08)}
  .linkBtn{background:transparent;border:none;color:#9ad7ff;font-weight:1000;cursor:pointer;text-decoration:underline}
  .tagPill{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,rgba(109,94,252,.30),rgba(56,212,166,.18));border:1px solid rgba(109,94,252,.50);font-weight:1000;font-size:12px}
  .tagPill.soft{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
  .detailGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .detailItem{padding:10px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
  .detailK{color:#9fb1d3;font-weight:900;font-size:12px}
  .detailV{margin-top:5px;font-weight:1000}
</style>

</body>
</html>
