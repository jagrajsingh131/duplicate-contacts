<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | Buckup-Media Data Duplicater</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

  <div class="card">
    <div class="brand">Buckup-Media Data Duplicater</div>
    <div class="sub">Login to access the dashboard. Verified email required.</div>

    <form id="loginForm">
      <label>Email</label>
      <input id="email" type="email" placeholder="example@gmail.com" required>

      <label>Password</label>
      <input id="password" type="password" placeholder="Your password" required>

      <div class="btnRow">
        <button class="primary" type="submit">Login</button>
        <button class="ghost" type="button" onclick="window.location.href='signup.html'">Create Account</button>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button id="resendBtn" class="info" type="button">Resend Verification Email</button>
        <button id="logoutBtn" class="ghost" type="button">Logout</button>
      </div>

      <div id="msgOk" class="msg ok"></div>
      <div id="msgInfo" class="msg info"></div>
      <div id="msgErr" class="msg err"></div>
    </form>

    <div class="footer">Tip: Check Spam/Promotions for verification email.</div>
  </div>

<script type="module">
  import { auth } from "./firebase.js";
  import {
    signInWithEmailAndPassword,
    sendEmailVerification,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const form = document.getElementById("loginForm");
  const ok = document.getElementById("msgOk");
  const info = document.getElementById("msgInfo");
  const err = document.getElementById("msgErr");
  const resendBtn = document.getElementById("resendBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function showOk(text){ ok.style.display="block"; info.style.display="none"; err.style.display="none"; ok.textContent=text; }
  function showInfo(text){ info.style.display="block"; ok.style.display="none"; err.style.display="none"; info.textContent=text; }
  function showErr(text){ err.style.display="block"; ok.style.display="none"; info.style.display="none"; err.textContent=text; }

  // optional: show info if already logged in
  onAuthStateChanged(auth, (user) => {
    if (user && user.emailVerified) {
      showOk("You are already logged in ✅ Redirecting...");
      setTimeout(() => window.location.href = "dashboard.html", 700);
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value;

    try {
      const userCred = await signInWithEmailAndPassword(auth, email, pass);

      if (!userCred.user.emailVerified) {
        showInfo("Email not verified. Click 'Resend Verification Email' then verify from Gmail.");
        return;
      }

      showOk("Login successful ✅ Redirecting...");
      setTimeout(() => window.location.href = "dashboard.html", 700);

    } catch (e2) {
      showErr((e2.code || "error") + " : " + (e2.message || e2));
      console.error(e2);
    }
  });

  resendBtn.addEventListener("click", async () => {
    try {
      if (!auth.currentUser) {
        showInfo("Login once first (unverified) then you can resend verification.");
        return;
      }
      await sendEmailVerification(auth.currentUser, {
        url: "https://jagrajsingh131.github.io/duplicate-contacts/index.html"
      });
      showOk("Verification email resent ✅ Check Inbox/Spam.");
    } catch (e2) {
      showErr((e2.code || "error") + " : " + (e2.message || e2));
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    showOk("Logged out ✅");
  });
</script>

</body>
</html>
