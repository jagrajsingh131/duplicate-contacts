<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Duplicater | Buckup-Media</title>
  <link rel="stylesheet" href="./style.css?v=3">
</head>
<body class="toolBody">

  <!-- Top Bar -->
  <header class="toolTop">
    <div class="toolBrand">
      <div class="toolLogo">BM</div>
      <div>
        <div class="toolTitle">Data Duplicater</div>
        <div class="toolSub">Upload / Paste → Duplicate → Copy / Download</div>
      </div>
    </div>

    <div class="toolActions">
      <button class="toolBtn ghost" id="homeBtn">Home</button>
      <button class="toolBtn ghost" id="clearBtnTop">Clear</button>
    </div>
  </header>

  <!-- Main -->
  <main class="toolMain">

    <!-- Upload + Actions -->
    <section class="toolCard">
      <div class="toolCardHead">
        <div>
          <div class="toolCardTitle">Input Options</div>
          <div class="toolCardSub">Upload a file or paste text</div>
        </div>
        <div class="toolCardRight">
          <button class="toolBtn primary" id="duplicateBtn" type="button">Duplicate</button>
        </div>
      </div>

      <div class="toolRow">
        <div class="toolField">
          <label class="toolLabel">Upload File (CSV/TXT)</label>
          <input class="toolInput" type="file" id="fileInput" accept=".csv,.txt">
          <div class="toolHint">Tip: After upload, click <b>Duplicate</b></div>
        </div>

        <div class="toolField">
          <label class="toolLabel">Download</label>
          <div class="toolBtnsRow">
            <button class="toolBtn success" id="copyBtn" type="button">Copy Output</button>
            <button class="toolBtn info" id="downloadCsvBtn" type="button">Download CSV</button>
          </div>
          <div class="toolHint">Output is saved locally per user</div>
        </div>
      </div>

      <div id="ok" class="toolMsg ok"></div>
      <div id="er" class="toolMsg err"></div>
    </section>

    <!-- Editors -->
    <section class="toolGrid">
      <div class="toolCard">
        <div class="toolCardHead">
          <div>
            <div class="toolCardTitle">Paste Input</div>
            <div class="toolCardSub">Paste name + number lines here</div>
          </div>
          <button class="toolBtn ghost" id="clearInputBtn" type="button">Clear Input</button>
        </div>
        <textarea class="toolArea" id="inputBox" rows="14" placeholder="Paste your data here..."></textarea>
      </div>

      <div class="toolCard">
        <div class="toolCardHead">
          <div>
            <div class="toolCardTitle">Duplicated Output</div>
            <div class="toolCardSub">Every line duplicated below itself</div>
          </div>
          <button class="toolBtn ghost" id="clearOutputBtn" type="button">Clear Output</button>
        </div>
        <textarea class="toolArea" id="outputBox" rows="14" placeholder="Output will appear here..."></textarea>
      </div>
    </section>

    <footer class="toolFoot">
      <div>© Buckup-Media Data Duplicater</div>
      <div class="toolMuted">Fast UI • Local storage enabled</div>
    </footer>

  </main>

<script type="module">
  import { auth } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getSession, getDuplicatedLocal, saveDuplicatedLocal } from "./cache.js";

  const ok = document.getElementById("ok");
  const er = document.getElementById("er");
  const showOk = (t)=>{ ok.style.display="block"; er.style.display="none"; ok.textContent=t; };
  const showEr = (t)=>{ er.style.display="block"; ok.style.display="none"; er.textContent=t; };

  const inputBox = document.getElementById("inputBox");
  const outputBox = document.getElementById("outputBox");
  const fileInput = document.getElementById("fileInput");

  // session check
  const session = getSession();
  if (!session) location.href = "index.html";

  onAuthStateChanged(auth, (user) => {
    if (!user || !user.emailVerified) location.href = "index.html";
  });

  // load last output instantly
  outputBox.value = getDuplicatedLocal();

  function duplicateLines(rawText) {
    const lines = rawText.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    const out = [];
    for (const line of lines) {
      out.push(line);
      out.push(line);
    }
    return out.join("\n");
  }

  // Home button
  document.getElementById("homeBtn").addEventListener("click", () => {
    location.href = "home.html";
  });

  // File upload read
  fileInput.addEventListener("change", async () => {
    const f = fileInput.files[0];
    if (!f) return;
    try {
      const text = await f.text();
      inputBox.value = text;
      showOk("File loaded ✅ Now click Duplicate.");
    } catch (e) {
      showEr("Cannot read file.");
    }
  });

  // Duplicate
  document.getElementById("duplicateBtn").addEventListener("click", () => {
    const result = duplicateLines(inputBox.value);
    outputBox.value = result;
    saveDuplicatedLocal(result);
    showOk("Duplicated ✅");
  });

  // Copy
  document.getElementById("copyBtn").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(outputBox.value);
      showOk("Copied ✅");
    } catch (e) {
      showEr("Copy failed. Please copy manually.");
    }
  });

  // Download CSV
  document.getElementById("downloadCsvBtn").addEventListener("click", () => {
    const blob = new Blob([outputBox.value], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "duplicated.csv";
    a.click();
  });

  // Clear helpers
  function clearAll() {
    inputBox.value = "";
    outputBox.value = "";
    saveDuplicatedLocal("");
    fileInput.value = "";
    showOk("Cleared ✅");
  }

  document.getElementById("clearBtnTop").addEventListener("click", clearAll);
  document.getElementById("clearInputBtn").addEventListener("click", () => {
    inputBox.value = "";
    showOk("Input cleared ✅");
  });
  document.getElementById("clearOutputBtn").addEventListener("click", () => {
    outputBox.value = "";
    saveDuplicatedLocal("");
    showOk("Output cleared ✅");
  });
</script>

</body>
</html>
