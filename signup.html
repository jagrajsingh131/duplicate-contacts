<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    createUserWithEmailAndPassword,
    sendEmailVerification,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    doc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const ok = document.getElementById("ok");
  const info = document.getElementById("info");
  const er = document.getElementById("er");

  const showOk = t => { ok.style.display="block"; info.style.display="none"; er.style.display="none"; ok.textContent=t; };
  const showInfo = t => { info.style.display="block"; ok.style.display="none"; er.style.display="none"; info.textContent=t; };
  const showEr = t => { er.style.display="block"; ok.style.display="none"; info.style.display="none"; er.textContent=t; };

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const confirmPasswordInput = document.getElementById("confirmPassword");

  // SIGNUP
  document.getElementById("signupForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = emailInput.value.trim();
    const pass = passwordInput.value;
    const cp = confirmPasswordInput.value;

    if (pass !== cp) {
      showEr("Passwords do not match.");
      return;
    }

    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, pass);

      await setDoc(doc(db, "users", userCred.user.uid), {
        name,
        phone,
        email,
        profileCompleted: false,
        createdAt: serverTimestamp()
      });

      await sendEmailVerification(userCred.user, {
        url: "https://jagrajsingh131.github.io/duplicate-contacts/index.html"
      });

      await signOut(auth);

      showOk("Account created ✅ Verification email sent. Please verify, then login.");
    }
    catch (err) {
      if (err.code === "auth/email-already-in-use") {
        showInfo(
          "This email is already registered.\n\n" +
          "Enter your password and click 'Resend Verification Email'."
        );
        return;
      }
      showEr(err.code + " : " + err.message);
    }
  });

  // ✅ CORRECT RESEND VERIFICATION
  document.getElementById("resendBtn").addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      showInfo("Enter your email and password to resend verification.");
      return;
    }

    try {
      // Login (even if unverified)
      const userCred = await signInWithEmailAndPassword(auth, email, password);

      if (userCred.user.emailVerified) {
        showOk("Your email is already verified. You can login now.");
        await signOut(auth);
        return;
      }

      await sendEmailVerification(userCred.user, {
        url: "https://jagrajsingh131.github.io/duplicate-contacts/index.html"
      });

      await signOut(auth);
      showOk("Verification email resent ✅ Check Inbox / Spam.");
    }
    catch (err) {
      showEr(err.code + " : " + err.message);
    }
  });
</script>
